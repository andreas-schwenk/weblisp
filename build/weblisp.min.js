var weblisp=(()=>{var d=(m,s)=>()=>(s||m((s={exports:{}}).exports,s),s.exports);var w=d(g=>{var p=class{constructor(){this.input="",this.sexpr=null,this.output="",this.startTime=0,this.maxSeconds=1/0,this.functions={},this.memoization={},this.vars=[{}]}getOutput(){return this.output}import(s){let i=s.split(`
`),e=[];for(let l of i){let t=l.split(";");e.push(t[0])}this.input=e.join(`
`);let a=[],u=this.input.length,f=1,c=1,h="";for(let l=0;l<u;l++){let t=this.input[l];switch(t){case"(":case")":case"+":case"*":h.length>0&&(a.push(h),h=""),a.push(t);break;case" ":case"	":case`
`:h.length>0&&(a.push(h),h="");break;default:h+=t}}h.length>0&&(a.push(h),h="");let r=["_PROG"],o=[];for(let l of a)switch(l){case"(":o.push(r),r=[];break;case")":if(o.length==0)throw Error('")" is not allowed');let t=o.pop();t.push(r),r=t;break;default:l.length>0&&l[0]>="0"&&l[0]<="9"?r.push(parseFloat(l)):r.push(l);break}this.sexpr=r}run(s=1/0){this.output="",this.functions={},this.vars=[{}],this.memoization={},this.startTime=Date.now(),this.maxSeconds=s,this.eval(this.sexpr)}eval(s){if(this.maxSeconds!=1/0&&(Date.now()-this.startTime)/1e3>this.maxSeconds)throw Error("max allowed runtime exceeded!");if(Array.isArray(s)){let i=s[0],e=s.slice(1),a,u,f,c,h,r,o,l;switch(i){case"_PROG":for(let t of e)this.eval(t);return null;case"write":return o=this.eval(e[0]),console.log(o),this.output+=""+o,o;case"+":u=0;for(let t of e)u+=this.eval(t);return u;case"*":f=1;for(let t of e)f*=this.eval(t);return f;case"-":u=0,c=e.length;for(let t=0;t<c;t++)t==1&&(u=-u),u-=this.eval(e[t]);return u;case"/":if(c=e.length,f=this.eval(e[0]),c==1)return 1/f;for(let t=1;t<c;t++)f/=this.eval(e[t]);return f;case"<":return this.eval(e[0])<this.eval(e[1]);case">":return this.eval(e[0])>this.eval(e[1]);case"terpri":return this.output+=`
`,null;case"defun":return a=e[0],this.functions[a]=s,null;case"defvar":case"setq":a=e[0],o=this.eval(e[1]),l=!1;for(let t=this.vars.length-1;t>=0;t--){let n=this.vars[t];if(a in n){n[a]=o,l=!0;break}}return l||(this.vars[this.vars.length-1][a]=o),o;case"let":case"let*":if(this.vars.push({}),i==="let*")for(let t of e[0])this.vars[this.vars.length-1][t[0]]=this.eval(t[1]);else{let t=[],n=0;for(let v of e[0])t.push(this.eval(v[1]));for(let v of e[0])this.vars[this.vars.length-1][v[0]]=t[n++]}r=null;for(let t of e.slice(1))r=this.eval(t);return this.vars.pop(),r;case"if":return this.eval(e[0])?this.eval(e[1]):e.length==3?this.eval(e[2]):null;case"dotimes":c=this.eval(e[0][1]);for(let t=0;t<c;t++){this.vars[this.vars.length-1][e[0][0]]=t,r=null;for(let n of e.slice(1))r=this.eval(n)}return r;default:if(i in this.functions){let t=this.functions[i];c=t.length,h=[];for(let n=0;n<t[2].length;n++)h.push(this.eval(e[n]));r=null,this.vars.push({});for(let n=0;n<t[2].length;n++)this.vars[this.vars.length-1][t[2][n]]=h[n];for(let n=3;n<c;n++)r=this.eval(t[n]);return this.vars.pop(),t[2].length==1&&(i in this.memoization||(this.memoization[i]={}),this.memoization[i][h[0]]=r),r}else throw new Error('error: unknown CAR "'+i+'"')}}else{if(typeof s=="number")return s;for(let i=this.vars.length-1;i>=0;i--){let e=this.vars[i];if(s in e)return e[s]}throw new Error('error: unimplemented SEXPR "'+s+'"')}}sexpr_toString(s){if(Array.isArray(s)){let i="(";for(let e=0;e<s.length;e++)e>0&&(i+=" "),i+=this.sexpr_toString(s[e]);return i+=")",i}else return""+s}};g.WebLISP=p});return w();})();
