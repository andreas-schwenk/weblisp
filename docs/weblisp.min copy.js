"use strict";var weblisp=(()=>{var u=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var f=u((exports,module)=>{var WebLISP=class{constructor(){this.input="",this.sexpr=null,this.output="",this.startTime=0,this.maxSeconds=1/0,this.functions={},this.memoization={},this.vars=[{}]}getOutput(){return this.output}import(r){let e=r.split(`
`),s=[];for(let t of e){let a=t.split(";");s.push(a[0])}this.input=s.join(`
`);let o=[],c=this.input.length,d=1,v=1,i="";for(let t=0;t<c;t++){let a=this.input[t];switch(a){case"(":case")":case"+":case"*":i.length>0&&(o.push(i),i=""),o.push(a);break;case" ":case"	":case`
`:i.length>0&&(o.push(i),i="");break;default:i+=a}}i.length>0&&(o.push(i),i="");let l=["_PROG"],h=[];for(let t of o)switch(t){case"(":h.push(l),l=[];break;case")":if(h.length==0)throw new Error('")" is not allowed');let a=h.pop();a.push(l),l=a;break;default:t.length>0&&t[0]>="0"&&t[0]<="9"?l.push(parseFloat(t)):l.push(t);break}this.sexpr=l}run(r=1/0){this.output="",this.functions={},this.vars=[{}],this.memoization={},this.startTime=Date.now(),this.maxSeconds=r,this.eval(this.sexpr)}eval(sexpr){if(this.maxSeconds!=1/0&&(Date.now()-this.startTime)/1e3>this.maxSeconds)throw new Error("max allowed runtime exceeded!");if(Array.isArray(sexpr)){if(sexpr.length==0)return null;let car=sexpr[0],cdr=sexpr.slice(1),id,sum,prod,n,x,y,val,found;switch(car){case"_PROG":for(let r of cdr)this.eval(r);return null;case"car":return y=this.eval(cdr),y.length>0?y[0]:null;case"cdr":return y=this.eval(cdr),y.length>0?y.slice(1):null;case"cons":if(cdr.length!=2)throw new Error("cons requires 2 arguments");return y=this.eval(cdr),cdr;case"length":if(cdr.length!=1)throw new Error("length requires 1 argument");if(y=this.eval(cdr[0]),Array.isArray(y)==!1)throw new Error("arg of length is not a list");return y.length;case"write":return val=this.eval(cdr[0]),console.log(val),this.output+=""+val,val;case"+":sum=0;for(let r of cdr)sum+=this.eval(r);return sum;case"*":prod=1;for(let r of cdr)prod*=this.eval(r);return prod;case"-":sum=0,n=cdr.length;for(let r=0;r<n;r++)r==1&&(sum=-sum),sum-=this.eval(cdr[r]);return sum;case"/":if(n=cdr.length,prod=this.eval(cdr[0]),n==1)return 1/prod;for(let r=1;r<n;r++)prod/=this.eval(cdr[r]);return prod;case"<":return this.eval(cdr[0])<this.eval(cdr[1]);case">":return this.eval(cdr[0])>this.eval(cdr[1]);case"terpri":return this.output+=`
`,null;case"defun":return id=cdr[0],this.functions[id]=sexpr,null;case"defvar":case"setq":id=cdr[0],val=this.eval(cdr[1]),found=!1;for(let r=this.vars.length-1;r>=0;r--){let e=this.vars[r];if(id in e){e[id]=val,found=!0;break}}return found||(this.vars[this.vars.length-1][id]=val),val;case"let":case"let*":if(this.vars.push({}),car==="let*")for(let r of cdr[0])this.vars[this.vars.length-1][r[0]]=this.eval(r[1]);else{let r=[],e=0;for(let s of cdr[0])r.push(this.eval(s[1]));for(let s of cdr[0])this.vars[this.vars.length-1][s[0]]=r[e++]}y=null;for(let r of cdr.slice(1))y=this.eval(r);return this.vars.pop(),y;case"if":return this.eval(cdr[0])?this.eval(cdr[1]):cdr.length==3?this.eval(cdr[2]):null;case"dotimes":n=this.eval(cdr[0][1]);for(let r=0;r<n;r++){this.vars[this.vars.length-1][cdr[0][0]]=r,y=null;for(let e of cdr.slice(1))y=this.eval(e)}return y;case"sin":if(cdr.length!=1)throw new Error("sin requires 1 argument");return Math.sin(this.eval(cdr[0]));case"cos":if(cdr.length!=1)throw new Error("cos requires 1 argument");return Math.cos(this.eval(cdr[0]));case"exp":if(cdr.length!=1)throw new Error("exp requires 1 argument");return Math.exp(this.eval(cdr[0]));case"sqrt":if(cdr.length!=1)throw new Error("sqrt requires 1 argument");return Math.sqrt(this.eval(cdr[0]));case"zerop":if(cdr.length!=1)throw new Error("zerop requires 1 argument");return eval(cdr[0])==0?!0:null;case"random":if(cdr.length!=1)throw new Error("random requires 1 argument");return x=this.eval(cdr[0]),Number.isInteger(cdr[0])?Math.floor(Math.random()*x):Math.random()*x;case"min":if(cdr.length<1)throw new Error("min requires at least one argument");x=[];for(let r of cdr)x.push(this.eval(r));y=1/0;for(let r of x)r<y&&(y=r);return y;case"max":if(cdr.length<1)throw new Error("min requires at least one argument");x=[];for(let r of cdr)x.push(this.eval(r));y=-1/0;for(let r of x)r>y&&(y=r);return y;default:if(car in this.functions){let r=this.functions[car];n=r.length,x=[];for(let e=0;e<r[2].length;e++)x.push(this.eval(cdr[e]));y=null,this.vars.push({});for(let e=0;e<r[2].length;e++)this.vars[this.vars.length-1][r[2][e]]=x[e];for(let e=3;e<n;e++)y=this.eval(r[e]);return this.vars.pop(),r[2].length==1&&(car in this.memoization||(this.memoization[car]={}),this.memoization[car][x[0]]=y),y}else throw new Error('error: unknown CAR "'+car+'"')}}else{if(typeof sexpr=="number")return sexpr;for(let r=this.vars.length-1;r>=0;r--){let e=this.vars[r];if(sexpr in e)return e[sexpr]}throw new Error('error: unimplemented SEXPR "'+sexpr+'"')}}sexpr_toString(r){if(Array.isArray(r)){let e="(";for(let s=0;s<r.length;s++)s>0&&(e+=" "),e+=this.sexpr_toString(r[s]);return e+=")",e}else return r==null?"NIL":r==!0?"T":""+r}};exports.WebLISP=WebLISP});return f();})();
