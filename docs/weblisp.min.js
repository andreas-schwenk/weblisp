"use strict";var weblisp=(()=>{var E=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var O=Object.prototype.hasOwnProperty;var S=(f,t)=>{for(var a in t)E(f,a,{get:t[a],enumerable:!0})},v=(f,t,a,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let e of k(t))!O.call(f,e)&&e!==a&&E(f,e,{get:()=>t[e],enumerable:!(n=R(t,e))||n.enumerable});return f};var A=f=>v(E({},"__esModule",{value:!0}),f);var D={};S(D,{CompileError:()=>y,DebugInfo:()=>w,RunError:()=>o,WebLISP:()=>g});var I=class{constructor(t){this.src="";this.len=0;this.pos=0;this.token="";this.tokenRow=0;this.tokenCol=0;this.row=1;this.col=1;this.eof=!1;this.src=t,this.len=t.length,this.next()}getToken(){return this.token}getRow(){return this.tokenRow}getCol(){return this.tokenCol}isEof(){return this.eof}next(){let t=!1,a=!1;for(;;){if(a=!1,this.pos>=this.len){this.eof=!0;return}let n=this.src[this.pos];switch(n){case" ":case"	":this.pos++,this.col+=n=="	"?4:1;break;case`
`:this.pos++,this.row++,this.col=1,t&&(t=!1);break;case";":this.pos++,this.col++,t=!0;break;default:t?(this.pos++,this.col++):a=!0}if(a)break}for(this.tokenCol=this.col,this.tokenRow=this.row,this.token="";;){if(this.pos>=this.len){this.token.length==0&&(this.eof=!0);return}let n=this.src[this.pos];if(n==" "||n=="	"||n==`
`||n==";")return;if(n=="("||n==")"||n=="'"){if(this.token!=="#"&&this.token.length>0)return;this.pos++,this.col++,this.token+=n;return}this.pos++,this.col++,this.token+=n.toUpperCase()}}};function C(f,t){for(;t!=0;){let a=t;t=f%t,f=a}return f}var d=class{constructor(t,a){this.numerator=t,this.denominator=a,this.reduce()}clone(){return new d(this.numerator,this.denominator)}reduce(){let t=C(this.numerator,this.denominator);this.numerator/=t,this.denominator/=t}compare(t){let a=this.clone();a.reduce();let n=t.clone();return n.reduce(),a.numerator==n.numerator&&a.denominator==n.denominator}static fromNumber(t){return new d(t,1)}static add(t,a){let n=new d(t.numerator*a.denominator+a.numerator*t.denominator,t.denominator*a.denominator);return n.reduce(),n}static sub(t,a){let n=new d(t.numerator*a.denominator-a.numerator*t.denominator,t.denominator*a.denominator);return n.reduce(),n}static mul(t,a){let n=new d(t.numerator*a.numerator,t.denominator*a.denominator);return n.reduce(),n}static div(t,a){let n=new d(t.numerator*a.denominator,t.denominator*a.numerator);return n.reduce(),n}toFloat(){return this.numerator/this.denominator}toString(){return""+this.numerator+"/"+this.denominator}};var r=class{constructor(t,a=-1,n=-1){this.car=null;this.cdr=null;this.srcRow=-1;this.srcCol=-1;this.type=t,this.srcRow=a,this.srcCol=n}set(t){this.type=t.type,this.data=t.data,this.car=t.car,this.cdr=t.cdr,this.srcRow=t.srcRow,this.srcCol=t.srcCol}static cons(t,a,n=-1,e=-1){let i=new r("CONS",n,e);return i.car=t,i.cdr=a,i}static defun(t,a,n=-1,e=-1){let i=new r("DEFUN",n,e);return i.car=r.atomID(t),i.cdr=a,i}static global(t,a=-1,n=-1){let e=new r("GLOBAL",a,n);return e.data=t,e}static atomNIL(t=-1,a=-1){return new r("NIL",t,a)}static atomINT(t,a=-1,n=-1){let e=new r("INT",a,n);return e.data=t,e}static atomRATIO(t,a,n=-1,e=-1){let i=new r("RATIO",n,e);return i.data=new d(t,a),i}static atomFLOAT(t,a=-1,n=-1){let e=new r("FLOAT",a,n);return e.data=t,e}static atomID(t,a=-1,n=-1){let e=new r("ID",a,n);return e.data=t,e}static atomSTRING(t,a=-1,n=-1){let e=new r("STR",a,n);return e.data=t,e}static atomT(t=-1,a=-1){return new r("T",t,a)}static len(t){let a=0;for(;t.type!=="NIL";)t=t.cdr,a++;return a}static nthcdr(t,a){let n=0;for(;t.type!=="NIL";){if(n==a)return t;t=t.cdr,n++}return r.atomNIL()}static nth(t,a){let n=0;for(;t.type!=="NIL";){if(n==a)return t.car;t=t.cdr,n++}return r.atomNIL()}static deepNth(t,a){let n=r.atomNIL();for(let e=0;e<a.length&&t.type!=="NIL";e++)n=t=r.nth(t,a[e]);return n}static equalp(t,a){if(t.type!==a.type)return!1;switch(t.type){case"CONS":if(r.equalp(t.car,a.car)==!1||r.equalp(t.cdr,a.cdr)==!1)return!1;break;case"INT":if(t.data!==a.data)return!1;break;case"FLOAT":let n=t.data,e=a.data;if(Math.abs(n-e)>1e-12)return!1;break;case"RATIO":if(t.data.compare(a.data)==!1)return!1;break;case"ID":case"STR":if(t.data!==a.data)return!1;break}return!0}remove(t){let a,n;a=r.atomNIL();let e=this,i=0;for(;e.type!=="NIL";){let s=e.car;s.type!=="CONS"&&s.type===t.type&&s.data===t.data||(i==0?a=n=r.cons(s,r.atomNIL()):(n.cdr=r.cons(s,r.atomNIL()),n=n.cdr)),e=e.cdr,i++}return a}static subst(t,a,n){return a.type==="CONS"?n:a.type===n.type&&a.data===n.data?t:n.type==="CONS"?r.cons(r.subst(t,a,n.car),r.subst(t,a,n.cdr)):n}toFloat(){switch(this.type){case"INT":case"FLOAT":return this.data;case"RATIO":return this.data.toFloat();default:return 0}}toCode(){switch(this.type){case"T":return"SExpr.atomT()";case"NIL":return"SExpr.atomNIL()";case"INT":case"FLOAT":return"SExpr.atomINT("+this.data+")";case"RATIO":return"SExpr.atomRATIO("+this.data.numerator+","+this.data.denominator+")";case"CONS":return"SExpr.cons("+this.car.toCode()+","+this.cdr.toCode()+")";default:throw Error("unimplemented SExpr.toCode() for type "+this.type)}}toString(){switch(this.type){case"NIL":return"NIL";case"T":return"T";case"INT":return""+this.data;case"FLOAT":return""+this.data;case"RATIO":return""+this.data.toString();case"ID":case"STR":case"GLOBAL":return this.data;case"DEFUN":return"FUNCTION "+this.car.data;case"CONS":let t="(",a=this,n=0;do{if(a.type==="NIL")break;if(n>0&&(t+=" "),a.type!="CONS"){t+=". "+a.toString();break}t+=a.car.toString(),a=a.cdr,n++}while(a!=null);return t+=")",t;default:throw new Error("unimplemented")}}};var T=class{static parse(t){let a=[];for(;!t.isEof();)a.push(this.parseRec(t));return a}static parseRec(t){if(t.getToken()==="T"){let a=r.atomT(t.getRow(),t.getCol());return t.next(),a}else if(t.getToken()==="NIL"){let a=r.atomNIL(t.getRow(),t.getCol());return t.next(),a}else if(t.getToken()==="#'"){t.next();let a=this.parseRec(t);return r.cons(r.atomID("FUNCTION"),r.cons(a,r.atomNIL()),t.getRow(),t.getCol())}else if(t.getToken()==="'"){t.next();let a=this.parseRec(t);return r.cons(r.atomID("QUOTE"),r.cons(a,r.atomNIL()),t.getRow(),t.getCol())}else if(t.getToken()==="("){t.next();let a=null,n=r.atomNIL(t.getRow(),t.getCol()),e=0,i=!1,s=0;for(;!t.isEof()&&t.getToken()!==")";){let c=this.parseRec(t);if(c.type==="ID"&&c.data==="."){if(e==0)throw new m("'.' is not allowed here.",c.srcRow,c.srcCol);i=!0,s++;continue}if(i){a.cdr=c,i=!1;break}let h=r.cons(c,r.atomNIL(),c.srcRow,c.srcCol);e==0&&(n=h),a!=null&&(a.cdr=h),a=h,e++}if(i||s>1)throw new m("'.' is not allowed here.",t.getRow(),t.getCol());if(t.getToken()===")")t.next();else throw new m("expected ')'",t.getRow(),t.getCol());return n}else if(t.getToken()==="."){let a=r.atomID(".",t.getRow(),t.getCol());return t.next(),a}else if(t.getToken()[0]>="0"&&t.getToken()[0]<="9"||t.getToken().length>1&&t.getToken()[0]=="-"){let a=t.getToken(),n;return a.includes(".")?n=r.atomFLOAT(parseFloat(a),t.getRow(),t.getCol()):a.includes("/")?n=r.atomRATIO(parseInt(a.split("/")[0]),parseInt(a.split("/")[1]),t.getRow(),t.getCol()):n=r.atomINT(parseInt(a),t.getRow(),t.getCol()),t.next(),n}else{let a=t.getToken(),n=r.atomID(a,t.getRow(),t.getCol());return t.next(),n}}},m=class extends Error{constructor(t,a=-1,n=-1){a<0?super("Error: "+t):super("Error:"+a+":"+n+": "+t),this.name="ParseError"}};var b=`"use strict";var RUNTIME=(()=>{var m=Object.defineProperty;var l=Object.getOwnPropertyDescriptor;var h=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var I=(i,t)=>{for(var r in t)m(i,r,{get:t[r],enumerable:!0})},b=(i,t,r,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of h(t))!N.call(i,a)&&a!==r&&m(i,a,{get:()=>t[a],enumerable:!(e=l(t,a))||e.enumerable});return i};var f=i=>b(m({},"__esModule",{value:!0}),i);var L={};I(L,{Ratio:()=>o,SExpr:()=>n,SExprType:()=>d});var d=(c=>(c.CONS="CONS",c.NIL="NIL",c.INT="INT",c.RATIO="RATIO",c.FLOAT="FLOAT",c.ID="ID",c.STR="STR",c.T="T",c.DEFUN="DEFUN",c.GLOBAL="GLOBAL",c))(d||{});function p(i,t){for(;t!=0;){let r=t;t=i%t,i=r}return i}var o=class{constructor(t,r){this.numerator=t,this.denominator=r,this.reduce()}clone(){return new o(this.numerator,this.denominator)}reduce(){let t=p(this.numerator,this.denominator);this.numerator/=t,this.denominator/=t}compare(t){let r=this.clone();r.reduce();let e=t.clone();return e.reduce(),r.numerator==e.numerator&&r.denominator==e.denominator}static fromNumber(t){return new o(t,1)}static add(t,r){let e=new o(t.numerator*r.denominator+r.numerator*t.denominator,t.denominator*r.denominator);return e.reduce(),e}static sub(t,r){let e=new o(t.numerator*r.denominator-r.numerator*t.denominator,t.denominator*r.denominator);return e.reduce(),e}static mul(t,r){let e=new o(t.numerator*r.numerator,t.denominator*r.denominator);return e.reduce(),e}static div(t,r){let e=new o(t.numerator*r.denominator,t.denominator*r.numerator);return e.reduce(),e}toFloat(){return this.numerator/this.denominator}toString(){return""+this.numerator+"/"+this.denominator}};var n=class{constructor(t,r=-1,e=-1){this.car=null;this.cdr=null;this.srcRow=-1;this.srcCol=-1;this.type=t,this.srcRow=r,this.srcCol=e}set(t){this.type=t.type,this.data=t.data,this.car=t.car,this.cdr=t.cdr,this.srcRow=t.srcRow,this.srcCol=t.srcCol}static cons(t,r,e=-1,a=-1){let s=new n("CONS",e,a);return s.car=t,s.cdr=r,s}static defun(t,r,e=-1,a=-1){let s=new n("DEFUN",e,a);return s.car=n.atomID(t),s.cdr=r,s}static global(t,r=-1,e=-1){let a=new n("GLOBAL",r,e);return a.data=t,a}static atomNIL(t=-1,r=-1){return new n("NIL",t,r)}static atomINT(t,r=-1,e=-1){let a=new n("INT",r,e);return a.data=t,a}static atomRATIO(t,r,e=-1,a=-1){let s=new n("RATIO",e,a);return s.data=new o(t,r),s}static atomFLOAT(t,r=-1,e=-1){let a=new n("FLOAT",r,e);return a.data=t,a}static atomID(t,r=-1,e=-1){let a=new n("ID",r,e);return a.data=t,a}static atomSTRING(t,r=-1,e=-1){let a=new n("STR",r,e);return a.data=t,a}static atomT(t=-1,r=-1){return new n("T",t,r)}static len(t){let r=0;for(;t.type!=="NIL";)t=t.cdr,r++;return r}static nthcdr(t,r){let e=0;for(;t.type!=="NIL";){if(e==r)return t;t=t.cdr,e++}return n.atomNIL()}static nth(t,r){let e=0;for(;t.type!=="NIL";){if(e==r)return t.car;t=t.cdr,e++}return n.atomNIL()}static deepNth(t,r){let e=n.atomNIL();for(let a=0;a<r.length&&t.type!=="NIL";a++)e=t=n.nth(t,r[a]);return e}static equalp(t,r){if(t.type!==r.type)return!1;switch(t.type){case"CONS":if(n.equalp(t.car,r.car)==!1||n.equalp(t.cdr,r.cdr)==!1)return!1;break;case"INT":if(t.data!==r.data)return!1;break;case"FLOAT":let e=t.data,a=r.data;if(Math.abs(e-a)>1e-12)return!1;break;case"RATIO":if(t.data.compare(r.data)==!1)return!1;break;case"ID":case"STR":if(t.data!==r.data)return!1;break}return!0}remove(t){let r,e;r=n.atomNIL();let a=this,s=0;for(;a.type!=="NIL";){let u=a.car;u.type!=="CONS"&&u.type===t.type&&u.data===t.data||(s==0?r=e=n.cons(u,n.atomNIL()):(e.cdr=n.cons(u,n.atomNIL()),e=e.cdr)),a=a.cdr,s++}return r}static subst(t,r,e){return r.type==="CONS"?e:r.type===e.type&&r.data===e.data?t:e.type==="CONS"?n.cons(n.subst(t,r,e.car),n.subst(t,r,e.cdr)):e}toFloat(){switch(this.type){case"INT":case"FLOAT":return this.data;case"RATIO":return this.data.toFloat();default:return 0}}toCode(){switch(this.type){case"T":return"SExpr.atomT()";case"NIL":return"SExpr.atomNIL()";case"INT":case"FLOAT":return"SExpr.atomINT("+this.data+")";case"RATIO":return"SExpr.atomRATIO("+this.data.numerator+","+this.data.denominator+")";case"CONS":return"SExpr.cons("+this.car.toCode()+","+this.cdr.toCode()+")";default:throw Error("unimplemented SExpr.toCode() for type "+this.type)}}toString(){switch(this.type){case"NIL":return"NIL";case"T":return"T";case"INT":return""+this.data;case"FLOAT":return""+this.data;case"RATIO":return""+this.data.toString();case"ID":case"STR":case"GLOBAL":return this.data;case"DEFUN":return"FUNCTION "+this.car.data;case"CONS":let t="(",r=this,e=0;do{if(r.type==="NIL")break;if(e>0&&(t+=" "),r.type!="CONS"){t+=". "+r.toString();break}t+=r.car.toString(),r=r.cdr,e++}while(r!=null);return t+=")",t;default:throw new Error("unimplemented")}}};return f(L);})();
`;var w=class{constructor(){this.breakpointLine=0;this.col=0;this.variableValues={}}},g=class{constructor(){this.interpret=!0;this.output="";this.program=[];this.code="";this.genVarCtr=0;this.functions={};this.variables=[{}];this.constants=new Set;this.startTime=0;this.maxSeconds=1/0;this.breakpoints=new Set;this.debugInfo=[];this.check=!0}import(t){let a=new I(t);this.program=T.parse(a)}getOutput(){return this.output}getDebugInfo(){return this.debugInfo}addBreakpoint(t){this.breakpoints.add(t)}compile(){this.interpret=!1,this.genVarCtr=0;let t="";for(let a of this.program){this.code="";let n=this.eval(a);t+=this.code+n.data}return console.log(t),t=b+"var SExprType=RUNTIME.SExprType;var SExpr=RUNTIME.SExpr;"+t,t}run(t=!0,a=1/0){this.interpret=!0,this.output="",this.debugInfo=[],t&&(this.functions={},this.variables=[{}],this.constants=new Set),this.startTime=Date.now(),this.maxSeconds=a;let n=[];for(let e of this.program)n.push(this.eval(e));return n}genVar(){return"__"+this.genVarCtr++}eval(t,a=!1){if(this.breakpoints.size>0&&this.breakpoints.has(t.srcRow)){let e=new w;this.debugInfo.length>0&&this.debugInfo[this.debugInfo.length-1].breakpointLine==t.srcRow&&this.debugInfo[this.debugInfo.length-1].col!=t.srcCol&&this.debugInfo.pop(),this.debugInfo.push(e),e.breakpointLine=t.srcRow,e.col=t.srcCol;let i=this.variables.length;for(let s=i-1;s>=0;s--)for(let c in this.variables[s]){let h=this.variables[s][c].toString();c in e.variableValues||(e.variableValues[c]=h)}}if(this.maxSeconds!=1/0&&(Date.now()-this.startTime)/1e3>this.maxSeconds)throw new o("max allowed runtime exceeded!");let n="";switch(t.type){case"NIL":return this.interpret?t:r.atomSTRING("SExpr.atomNIL()");case"T":return this.interpret?t:r.atomSTRING("SExpr.atomT()");case"INT":return this.interpret?t:r.atomSTRING("SExpr.atomINT("+t.data+")");case"RATIO":return this.interpret?t:r.atomSTRING("SExpr.atomRATIO("+t.data.numerator+","+t.data.denominator+")");case"FLOAT":return this.interpret?t:r.atomSTRING("SExpr.atomFLOAT("+t.data+")");case"ID":{if(this.interpret==!1)throw new o("case T.ID NOT IMPLEMENTED");let e=t.data,i=this.variables.length;for(let s=i-1;s>=0;s--)if(e in this.variables[s])return this.variables[s][e];if(a)return this.variables[i-1][e]=r.atomNIL(),this.variables[i-1][e];throw new o("unknown symbol "+e)}case"CONS":switch(t.car.type){case"INT":case"RATIO":case"FLOAT":case"STR":throw new o(""+t.car.data+" is not a function name");case"CONS":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");let e=this.eval(t.car);if(this.check&&e.type!=="DEFUN")throw new o("not a function");return this.call(e.cdr.car,t.cdr,e.cdr.cdr)}case"ID":switch(n=t.car.data,n){case"+":case"*":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");let e=r.atomINT(n==="+"?0:1);for(let i=t.cdr,s=0;i.type==="CONS";i=i.cdr,s++){let c=this.eval(i.car);if(e.type==="INT"&&c.type==="INT")n==="+"?e.data+=c.data:e.data*=c.data;else if(e.type==="INT"&&c.type==="RATIO"){let h=d.fromNumber(e.data),u=c.data;e.data=n==="+"?d.add(h,u):d.mul(h,u),e.type="RATIO"}else if(e.type==="RATIO"&&c.type==="INT"){let h=e.data,u=d.fromNumber(c.data);e.data=n==="+"?d.add(h,u):d.mul(h,u),e.type="RATIO"}else if(e.type==="RATIO"&&c.type==="RATIO"){let h=e.data,u=c.data;e.data=n==="+"?d.add(h,u):d.mul(h,u),e.type="RATIO"}else if(["INT","RATIO","FLOAT"].includes(e.type)&&["INT","RATIO","FLOAT"].includes(c.type)){let h=e.type==="RATIO"?e.data.toFloat():e.data,u=c.type==="RATIO"?c.data.toFloat():c.data;e.data=n==="+"?h+u:h*u,e.type="FLOAT"}else throw new o("incompatible types "+e.type+" and "+c.type+" for op "+n)}return e.type==="RATIO"&&e.data.denominator==1&&(e.data=e.data.numerator,e.type="INT"),e}case"-":case"/":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");let e=r.atomINT(n==="-"?0:1);for(let i=t.cdr,s=0;i.type==="CONS";i=i.cdr,s++){let c=this.eval(i.car);if(s==0&&i.cdr.type!=="NIL")e.type=c.type,e.data=c.data;else if(e.type==="INT"&&c.type==="INT")if(n==="-")e.data-=c.data;else{let h=e.data,u=c.data;e.data=new d(h,u),e.type="RATIO"}else if(e.type==="INT"&&c.type==="RATIO"){let h;h=d.fromNumber(e.data);let u=c.data;e.data=n==="-"?d.sub(h,u):d.div(h,u),e.type="RATIO"}else if(e.type==="RATIO"&&c.type==="INT"){let h=e.data,u=d.fromNumber(c.data);e.data=n==="-"?d.sub(h,u):d.div(h,u),e.type="RATIO"}else if(e.type==="RATIO"&&c.type==="RATIO"){let h=e.data,u=c.data;e.data=n==="-"?d.sub(h,u):d.div(h,u),e.type="RATIO"}else if(["INT","RATIO","FLOAT"].includes(e.type)&&["INT","RATIO","FLOAT"].includes(c.type)){let h=e.type==="RATIO"?e.data.toFloat():c.data,u=c.type==="RATIO"?c.data.toFloat():c.data;e.data=n==="-"?h-u:h/u,e.type="FLOAT"}else throw new o("incompatible types "+e.type+" and "+c.type+" for op "+n)}return e.type==="RATIO"&&e.data.denominator==1&&(e.data=e.data.numerator,e.type="INT"),e}case">":case">=":case"<":case"<=":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");let e=!0,i=n===">"||n===">="?1/0:-1/0,s;for(let c=t.cdr,h=0;c.type=="CONS";c=c.cdr,h++){let u=this.eval(c.car);switch(u.type){case"INT":let l=u.data;if(n===">"&&l>=i||n===">="&&l>i||n==="<"&&l<=i||n==="<="&&l<i){e=!1;break}else i=l;break;default:throw new o(u.toString()+" is not a number")}}if(s==0)throw new o("too few args");return e?r.atomT():r.atomNIL()}case"AND":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");let e=r.atomT();for(let i=t.cdr;i.type==="CONS";i=i.cdr){let s=this.eval(i.car);if(s.type==="NIL")return s;e=s}return e}case"APPLY":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");this.check&&this.checkMinArgCount(t,2);let e=this.eval(t.cdr.car);if(this.check&&e.type!=="DEFUN")throw new o("expected a function");let i=this.eval(t.cdr.cdr.car);return this.call(e.cdr.car,i,e.cdr.cdr)}case"ATOM":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");return this.check&&this.checkArgCount(t,1),this.eval(t.cdr.car).type!=="CONS"?r.atomT():r.atomNIL()}case"CAR":if(this.interpret){this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car);if(this.check&&e.type!=="CONS")throw new o(n+" expects a list");return e.car}else return r.atomSTRING(this.eval(t.cdr.car)+".car");case"CDR":if(this.interpret){this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car);if(this.check&&e.type!=="CONS")throw new o(n+" expects a list");return e.cdr}else return r.atomSTRING(this.eval(t.cdr.car)+".cdr");case"CONS":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");return this.check&&this.checkArgCount(t,2),r.cons(this.eval(t.cdr.car),this.eval(t.cdr.cdr.car))}case"CONSP":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");return this.check&&this.checkArgCount(t,1),this.eval(t.cdr.car).type==="CONS"?r.atomT():r.atomNIL()}case"COS":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car);return this.check&&this.checkIsNumber(e),r.atomFLOAT(Math.cos(e.toFloat()))}case"DEFCONSTANT":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");this.check&&this.checkArgCount(t,2);let e=t.cdr.car,i=this.eval(t.cdr.cdr.car);if(this.check&&e.type!=="ID")throw new o("expected ID");let s=e.data;return this.variables[0][s]=i,this.constants.add(s),r.global(s)}case"DEFPARAMETER":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");this.check&&this.checkArgCount(t,2);let e=t.cdr.car,i=this.eval(t.cdr.cdr.car);if(this.check&&e.type!=="ID")throw new o("expected ID");let s=e.data;return this.variables[0][s]=i,r.global(s)}case"DEFUN":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");if(this.check&&(this.checkMinArgCount(t,2),r.nth(t,1).type!=="ID"||r.nth(t,2).type!=="CONS"))throw new o("DEFUN is not well structured");let e=r.nth(t,1).data,i=r.nthcdr(t,2);return this.functions[e]=i,r.defun(e,i)}case"DO":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");let e=r.atomNIL(),i={};this.variables.push(i);let s=r.nth(t,1),c=r.nth(t,2),h=r.nthcdr(t,3);if(this.check&&(s.type!=="CONS"||c.type!=="CONS"))throw new o("DO is not well structured");for(let u=s;u.type!=="NIL";u=u.cdr){let l=r.nth(u.car,0);if(this.check&&l.type!=="ID")throw new o("expected ID");let p=this.eval(r.nth(u.car,1));i[l.data]=p}for(;;){let u=!1;for(let l=0,p=c;p.type!=="NIL";l++,p=p.cdr){let N=this.eval(p.car);if(l==0)if(N.type==="T")u=!0;else break;l>0&&(e=N)}if(u)break;for(let l=h;l.type!=="NIL";l=l.cdr)this.eval(l.car);for(let l=s;l.type!=="NIL";l=l.cdr){let p=r.nth(l.car,0),N=this.eval(r.nth(l.car,2));i[p.data]=N}}return this.variables.pop(),e}case"DOLIST":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");let e=r.atomNIL(),i={};this.variables.push(i);let s=r.deepNth(t,[1,0]);if(this.check&&s.type!=="ID")throw new o("expected ID");let c=this.eval(r.deepNth(t,[1,1])),h=r.nthcdr(t,2);for(;c.type!=="NIL";){i[s.data]=c.car;for(let u=h;u.type!=="NIL";u=u.cdr)this.eval(u.car);c=c.cdr}return this.variables.pop(),e}case"EQUALP":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");return this.check&&this.checkArgCount(t,2),r.equalp(this.eval(t.cdr.car),this.eval(t.cdr.cdr.car))?r.atomT():r.atomNIL()}case"FUNCALL":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");this.check&&this.checkMinArgCount(t,2);let e=this.eval(t.cdr.car);if(this.check&&e.type!=="DEFUN")throw new o("expected a function");return this.call(e.cdr.car,t.cdr.cdr,e.cdr.cdr)}case"FUNCTION":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");this.check&&this.checkArgCount(t,1);let e=t.cdr.car;if(this.check&&e.type!=="ID")throw new o("expected ID");let i=e.data;if(this.check&&!(i in this.functions))throw new o("undefined function "+i);return r.defun(i,this.functions[i])}case"IF":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");return this.checkMinArgCount(t,2),this.eval(r.nth(t,1)).type!=="NIL"?this.eval(r.nth(t,2)):this.eval(r.nth(t,3))}case"LAMBDA":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");return r.defun("LAMBDA",r.nthcdr(t,1))}case"LENGTH":if(this.interpret){this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car),i;for(i=0;e.type==="CONS";i++)e=e.cdr;return r.atomINT(i)}else{let e=this.genVar(),i=this.genVar(),s=this.generate(t.cdr.car),c=`let ${e}=${s};
let ${i};
for(${i}=0; ${e}.type === SExprType.CONS; ${i}++)
  ${e} = ${e}.cdr;
`;return this.code+=c,r.atomSTRING(`SExpr.atomINT(${i})`)}case"LET":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");let e=r.atomNIL(),i={};this.variables.push(i);let s=r.nth(t,1),c=r.nthcdr(t,2);for(let h=s;h.type!=="NIL";h=h.cdr){if(this.check&&r.len(h.car)!=2)throw new o("expected (id init)");let u=r.nth(h.car,0);if(this.check&&u.type!=="ID")throw new o("expected ID");let l=this.eval(r.nth(h.car,1));i[u.data]=l}for(let h=c;h.type!=="NIL";h=h.cdr)e=this.eval(h.car);return this.variables.pop(),e}case"LIST":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");let e,i;e=i=r.atomNIL();for(let s=t.cdr,c=0;s.type==="CONS";s=s.cdr,c++){let h=this.eval(s.car),u=r.cons(h,r.atomNIL());c==0?e=i=u:(i.cdr=u,i=i.cdr)}return e}case"LISTP":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car);return e.type==="CONS"||e.type==="NIL"?r.atomT():r.atomNIL()}case"MEMBER":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");this.check&&this.checkArgCount(t,2);let e=this.eval(r.nth(t,1)),i=this.eval(r.nth(t,2)),s=r.atomNIL();for(let c=i;c.type!=="NIL";c=c.cdr)r.equalp(e,c.car)&&(s=c);return s}case"NOT":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");return this.check&&this.checkArgCount(t,1),this.eval(t.cdr.car).type==="NIL"?r.atomT():r.atomNIL()}case"NTH":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");this.check&&this.checkArgCount(t,2);let e=t.cdr.car,i=this.eval(t.cdr.cdr.car);if(this.check&&e.type!=="INT")throw new o("expected an integer index");let s=e.data;if(this.check&&s<0)throw new o("expected a non-negative integer index");return r.nth(i,s)}case"NTHCDR":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");this.check&&this.checkArgCount(t,2);let e=t.cdr.car,i=this.eval(t.cdr.cdr.car);if(this.check&&e.type!=="INT")throw new o("expected an integer index");let s=e.data;if(this.check&&s<0)throw new o("expected a non-negative integer index");return r.nthcdr(i,s)}case"NULL":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");return this.check&&this.checkArgCount(t,1),this.eval(t.cdr.car).type==="NIL"?r.atomT():r.atomNIL()}case"NUMBERP":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car);return e.type==="INT"||e.type==="FLOAT"||e.type==="RATIO"?r.atomT():r.atomNIL()}case"OR":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");let e=r.atomNIL();for(let i=t.cdr;i.type==="CONS";i=i.cdr){let s=this.eval(i.car);if(s.type!=="NIL")return s;e=s}return e}case"PROGN":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");let e=r.atomNIL();for(let i=t.cdr;i.type==="CONS";i=i.cdr)e=this.eval(i.car);return e}case"QUOTE":return this.interpret?(this.check&&this.checkArgCount(t,1),t.cdr.car):r.atomSTRING(t.cdr.car.toCode());case"REMOVE":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");this.check&&this.checkArgCount(t,2);let e=t.cdr.car;return this.eval(t.cdr.cdr.car).remove(e)}case"TAN":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car);return this.check&&this.checkIsNumber(e),r.atomFLOAT(Math.tan(e.toFloat()))}case"THIRD":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car);return r.nth(e,2)}case"TYPEP":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");this.check&&this.checkArgCount(t,2);let e=this.eval(t.cdr.car),i=this.eval(t.cdr.cdr.car);if(this.check&&i.type!=="ID")throw new o("expected ID as second param");let s=i.data;if(this.check&&["INTEGER","FLOAT","RATIO"].includes(s)==!1)throw new o("unexpected TYPE "+s);if(e.type==="INT"&&s==="INTEGER"||e.type==="FLOAT"&&s==="FLOAT"||e.type==="RATIO"&&s==="RATIO")return r.atomT();r.atomNIL()}case"SETF":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");let e=r.len(t);this.check&&this.checkEvenArgCount(t);let i=r.atomNIL();for(let s=t.cdr;s.type!=="NIL";s=s.cdr){let c=s.car;i=this.eval(c,!0),s=s.cdr;let h=this.eval(s.car);i.set(h)}return i}case"SIN":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car);return this.check&&this.checkIsNumber(e),r.atomFLOAT(Math.sin(e.toFloat()))}case"SUBSTITUTE":case"SUBST":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");this.check&&this.checkArgCount(t,3);let e=this.eval(r.nth(t,1)),i=this.eval(r.nth(t,2)),s=this.eval(r.nth(t,3));return r.subst(e,i,s)}case"TERPRI":{if(this.interpret==!1)throw new o("UNIMPLEMENTED");return this.output+=`
`,r.atomNIL()}case"WRITE":if(this.interpret){this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car);return this.output+=e.toString(),console.log(e.toString()),e}else{let e=this.genVar(),i=`let ${e} = ${this.eval(t.cdr.car)};`;return this.code+=i,this.code+=`console.log(${e}.toString());`,r.atomSTRING(e)}default:{if(this.interpret==!1)throw new o("UNIMPLEMENTED");let e=this.functions[n];if(this.check&&e==null)throw new o("unknown function "+n);return this.call(e.car,t.cdr,e.cdr)}}default:throw new o("not allowed")}default:throw new o("unimplemented sexpr type "+t.type)}}call(t,a,n){let e={};this.variables.push(e);let i,s;for(i=a,s=t;s.type!=="NIL";i=i.cdr,s=s.cdr){if(this.check&&i.type==="NIL")throw new o("too few arguments");let h=s.car;if(this.check&&h.type!=="ID")throw new o("parameter must be an ID");e[h.data]=this.eval(i.car)}if(this.check&&i.type!=="NIL")throw new o("too many arguments");let c=r.atomNIL();for(;n.type!=="NIL";n=n.cdr)c=this.eval(n.car);return this.variables.pop(),c}checkArgCount(t,a){if(r.len(t)!=a+1)throw new o("expected "+a+" argument"+(a>0?"s":"#"))}checkMinArgCount(t,a){if(r.len(t)<a+1)throw new o("expected "+a+"+ argument"+(a>0?"s":"#"))}checkEvenArgCount(t){if((r.len(t)-1)%2!=0)throw new o("expected an even number of arguments")}checkIsNumber(t){if(t.type!=="INT"&&t.type!=="FLOAT"&&t.type!=="RATIO")throw new o("expected a number")}},y=class extends Error{constructor(t){super("Error: "+t),this.name="CompileError"}},o=class extends Error{constructor(t){super("Error: "+t),this.name="RunError"}};return A(D);})();
