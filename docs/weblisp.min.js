"use strict";var weblisp=(()=>{var b=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var O=Object.prototype.hasOwnProperty;var S=(h,t)=>{for(var s in t)b(h,s,{get:t[s],enumerable:!0})},A=(h,t,s,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let e of L(t))!O.call(h,e)&&e!==s&&b(h,e,{get:()=>t[e],enumerable:!(a=R(t,e))||a.enumerable});return h};var v=h=>A(b({},"__esModule",{value:!0}),h);var C={};S(C,{DebugInfo:()=>w,RunError:()=>d,WebLISP:()=>y});var N=class{constructor(t){this.src="";this.len=0;this.pos=0;this.token="";this.tokenRow=0;this.tokenCol=0;this.row=1;this.col=1;this.eof=!1;this.src=t,this.len=t.length,this.next()}getToken(){return this.token}getRow(){return this.tokenRow}getCol(){return this.tokenCol}isEof(){return this.eof}next(){let t=!1,s=!1;for(;;){if(s=!1,this.pos>=this.len){this.eof=!0;return}let a=this.src[this.pos];switch(a){case" ":case"	":this.pos++,this.col+=a=="	"?4:1;break;case`
`:this.pos++,this.row++,this.col=1,t&&(t=!1);break;case";":this.pos++,this.col++,t=!0;break;default:t?(this.pos++,this.col++):s=!0}if(s)break}for(this.tokenCol=this.col,this.tokenRow=this.row,this.token="";;){if(this.pos>=this.len){this.token.length==0&&(this.eof=!0);return}let a=this.src[this.pos];if(a==" "||a=="	"||a==`
`||a==";")return;if(a=="("||a==")"||a=="'"){if(this.token!=="#"&&this.token.length>0)return;this.pos++,this.col++,this.token+=a;return}this.pos++,this.col++,this.token+=a.toUpperCase()}}};function E(h,t){for(;t!=0;){let s=t;t=h%t,h=s}return h}var l=class{constructor(t,s){this.numerator=t,this.denominator=s,this.reduce()}clone(){return new l(this.numerator,this.denominator)}reduce(){let t=E(this.numerator,this.denominator);this.numerator/=t,this.denominator/=t}compare(t){let s=this.clone();s.reduce();let a=t.clone();return a.reduce(),s.numerator==a.numerator&&s.denominator==a.denominator}static fromNumber(t){return new l(t,1)}static add(t,s){let a=new l(t.numerator*s.denominator+s.numerator*t.denominator,t.denominator*s.denominator);return a.reduce(),a}static sub(t,s){let a=new l(t.numerator*s.denominator-s.numerator*t.denominator,t.denominator*s.denominator);return a.reduce(),a}static mul(t,s){let a=new l(t.numerator*s.numerator,t.denominator*s.denominator);return a.reduce(),a}static div(t,s){let a=new l(t.numerator*s.denominator,t.denominator*s.numerator);return a.reduce(),a}toFloat(){return this.numerator/this.denominator}toString(){return""+this.numerator+"/"+this.denominator}};var r=class{constructor(t,s=-1,a=-1){this.car=null;this.cdr=null;this.srcRow=-1;this.srcCol=-1;this.type=t,this.srcRow=s,this.srcCol=a}set(t){this.type=t.type,this.data=t.data,this.car=t.car,this.cdr=t.cdr,this.srcRow=t.srcRow,this.srcCol=t.srcCol}static cons(t,s,a=-1,e=-1){let n=new r("CONS",a,e);return n.car=t,n.cdr=s,n}static defun(t,s,a=-1,e=-1){let n=new r("DEFUN",a,e);return n.car=r.atomID(t),n.cdr=s,n}static global(t,s=-1,a=-1){let e=new r("GLOBAL",s,a);return e.data=t,e}static atomNIL(t=-1,s=-1){return new r("NIL",t,s)}static atomINT(t,s=-1,a=-1){let e=new r("INT",s,a);return e.data=t,e}static atomRATIO(t,s,a=-1,e=-1){let n=new r("RATIO",a,e);return n.data=new l(t,s),n}static atomFLOAT(t,s=-1,a=-1){let e=new r("FLOAT",s,a);return e.data=t,e}static atomID(t,s=-1,a=-1){let e=new r("ID",s,a);return e.data=t,e}static atomSTRING(t,s=-1,a=-1){let e=new r("STR",s,a);return e.data=t,e}static atomT(t=-1,s=-1){return new r("T",t,s)}static len(t){let s=0;for(;t.type!=="NIL";)t=t.cdr,s++;return s}static nthcdr(t,s){let a=0;for(;t.type!=="NIL";){if(a==s)return t;t=t.cdr,a++}return r.atomNIL()}static nth(t,s){let a=0;for(;t.type!=="NIL";){if(a==s)return t.car;t=t.cdr,a++}return r.atomNIL()}static deepNth(t,s){let a=r.atomNIL();for(let e=0;e<s.length&&t.type!=="NIL";e++)a=t=r.nth(t,s[e]);return a}static equalp(t,s){if(t.type!==s.type)return!1;switch(t.type){case"CONS":if(r.equalp(t.car,s.car)==!1||r.equalp(t.cdr,s.cdr)==!1)return!1;break;case"INT":if(t.data!==s.data)return!1;break;case"FLOAT":let a=t.data,e=s.data;if(Math.abs(a-e)>1e-12)return!1;break;case"RATIO":if(t.data.compare(s.data)==!1)return!1;break;case"ID":case"STR":if(t.data!==s.data)return!1;break}return!0}remove(t){let s,a;s=r.atomNIL();let e=this,n=0;for(;e.type!=="NIL";){let o=e.car;o.type!=="CONS"&&o.type===t.type&&o.data===t.data||(n==0?s=a=r.cons(o,r.atomNIL()):(a.cdr=r.cons(o,r.atomNIL()),a=a.cdr)),e=e.cdr,n++}return s}toString(){switch(this.type){case"NIL":return"NIL";case"T":return"T";case"INT":return""+this.data;case"FLOAT":return""+this.data;case"RATIO":return""+this.data.toString();case"ID":case"STR":case"GLOBAL":return this.data;case"DEFUN":return"FUNCTION "+this.car.data;case"CONS":let t="(",s=this,a=0;do{if(s.type==="NIL")break;if(a>0&&(t+=" "),s.type!="CONS"){t+=". "+s.toString();break}t+=s.car.toString(),s=s.cdr,a++}while(s!=null);return t+=")",t;default:throw new Error("unimplemented")}}};var T=class{static parse(t){let s=[];for(;!t.isEof();)s.push(this.parseRec(t));return s}static parseRec(t){if(t.getToken()==="T"){let s=r.atomT(t.getRow(),t.getCol());return t.next(),s}else if(t.getToken()==="NIL"){let s=r.atomNIL(t.getRow(),t.getCol());return t.next(),s}else if(t.getToken()==="#'"){t.next();let s=this.parseRec(t);return r.cons(r.atomID("FUNCTION"),r.cons(s,r.atomNIL()),t.getRow(),t.getCol())}else if(t.getToken()==="'"){t.next();let s=this.parseRec(t);return r.cons(r.atomID("QUOTE"),r.cons(s,r.atomNIL()),t.getRow(),t.getCol())}else if(t.getToken()==="("){t.next();let s=null,a=r.atomNIL(t.getRow(),t.getCol()),e=0,n=!1,o=0;for(;!t.isEof()&&t.getToken()!==")";){let i=this.parseRec(t);if(i.type==="ID"&&i.data==="."){if(e==0)throw new f("'.' is not allowed here.",i.srcRow,i.srcCol);n=!0,o++;continue}if(n){s.cdr=i,n=!1;break}let u=r.cons(i,r.atomNIL(),i.srcRow,i.srcCol);e==0&&(a=u),s!=null&&(s.cdr=u),s=u,e++}if(n||o>1)throw new f("'.' is not allowed here.",t.getRow(),t.getCol());if(t.getToken()===")")t.next();else throw new f("expected ')'",t.getRow(),t.getCol());return a}else if(t.getToken()==="."){let s=r.atomID(".",t.getRow(),t.getCol());return t.next(),s}else if(t.getToken()[0]>="0"&&t.getToken()[0]<="9"||t.getToken().length>1&&t.getToken()[0]=="-"){let s=t.getToken(),a;return s.includes(".")?a=r.atomFLOAT(parseFloat(s),t.getRow(),t.getCol()):s.includes("/")?a=r.atomRATIO(parseInt(s.split("/")[0]),parseInt(s.split("/")[1]),t.getRow(),t.getCol()):a=r.atomINT(parseInt(s),t.getRow(),t.getCol()),t.next(),a}else{let s=t.getToken(),a=r.atomID(s,t.getRow(),t.getCol());return t.next(),a}}},f=class extends Error{constructor(t,s=-1,a=-1){s<0?super("Error: "+t):super("Error:"+s+":"+a+": "+t),this.name="ParseError"}};var w=class{constructor(){this.breakpointLine=0;this.col=0;this.variableValues={}}},y=class{constructor(){this.output="";this.program=[];this.functions={};this.variables=[{}];this.constants=new Set;this.startTime=0;this.maxSeconds=1/0;this.breakpoints=new Set;this.debugInfo=[]}import(t){let s=new N(t);this.program=T.parse(s)}getOutput(){return this.output}getDebugInfo(){return this.debugInfo}addBreakpoint(t){this.breakpoints.add(t)}run(t=!0,s=1/0){this.output="",this.debugInfo=[],t&&(this.functions={},this.variables=[{}],this.constants=new Set),this.startTime=Date.now(),this.maxSeconds=s;let a=[];for(let e of this.program)a.push(this.eval(e));return a}eval(t,s=!1){if(this.breakpoints.size>0&&this.breakpoints.has(t.srcRow)){let e=new w;this.debugInfo.length>0&&this.debugInfo[this.debugInfo.length-1].breakpointLine==t.srcRow&&this.debugInfo[this.debugInfo.length-1].col!=t.srcCol&&this.debugInfo.pop(),this.debugInfo.push(e),e.breakpointLine=t.srcRow,e.col=t.srcCol;let n=this.variables.length;for(let o=n-1;o>=0;o--)for(let i in this.variables[o]){let u=this.variables[o][i].toString();i in e.variableValues||(e.variableValues[i]=u)}}if(this.maxSeconds!=1/0&&(Date.now()-this.startTime)/1e3>this.maxSeconds)throw new d("max allowed runtime exceeded!");let a="";switch(t.type){case"NIL":case"T":case"INT":case"RATIO":case"FLOAT":return t;case"ID":{let e=t.data,n=this.variables.length;for(let o=n-1;o>=0;o--)if(e in this.variables[o])return this.variables[o][e];if(s)return this.variables[n-1][e]=r.atomNIL(),this.variables[n-1][e];throw new d("unknown symbol "+e)}case"CONS":switch(t.car.type){case"ID":switch(a=t.car.data,a){case"TERPRI":return this.output+=`
`,r.atomNIL();case"IF":{if(r.len(t)<3)throw new d("expected 2+ args for "+a);return this.eval(r.nth(t,1)).type!=="NIL"?this.eval(r.nth(t,2)):this.eval(r.nth(t,3))}case"LET":{let e=r.atomNIL(),n={};this.variables.push(n);let o=r.nth(t,1),i=r.nthcdr(t,2);for(let u=o;u.type!=="NIL";u=u.cdr){if(r.len(u.car)!=2)throw new d("expected (id init)");let c=r.nth(u.car,0);if(c.type!=="ID")throw new d("expected ID");let p=this.eval(r.nth(u.car,1));n[c.data]=p}for(let u=i;u.type!=="NIL";u=u.cdr)e=this.eval(u.car);return this.variables.pop(),e}case"SETF":{if((r.len(t)-1)%2!=0)throw new d("SETF requires an even number of arguments");let n=r.atomNIL();for(let o=t.cdr;o.type!=="NIL";o=o.cdr){let i=o.car;n=this.eval(i,!0),o=o.cdr;let u=this.eval(o.car);n.set(u)}return n}case"DO":{let e=r.atomNIL(),n={};this.variables.push(n);let o=r.nth(t,1),i=r.nth(t,2),u=r.nthcdr(t,3);if(o.type!=="CONS"||i.type!=="CONS")throw new d("DO is not well structured");for(let c=o;c.type!=="NIL";c=c.cdr){let p=r.nth(c.car,0);if(p.type!=="ID")throw new d("expected ID");let m=this.eval(r.nth(c.car,1));n[p.data]=m}for(;;){let c=!1;for(let p=0,m=i;m.type!=="NIL";p++,m=m.cdr){let I=this.eval(m.car);if(p==0)if(I.type==="T")c=!0;else break;p>0&&(e=I)}if(c)break;for(let p=u;p.type!=="NIL";p=p.cdr)this.eval(p.car);for(let p=o;p.type!=="NIL";p=p.cdr){let m=r.nth(p.car,0),I=this.eval(r.nth(p.car,2));n[m.data]=I}}return this.variables.pop(),e}case"DEFUN":{if(r.len(t)<3||r.nth(t,1).type!=="ID"||r.nth(t,2).type!=="CONS")throw new d("DEFUN is not well structured");let e=r.nth(t,1).data,n=r.nthcdr(t,2);return this.functions[e]=n,r.defun(e,n)}case"LAMBDA":{let e=r.nthcdr(t,1);return r.defun("LAMBDA",e)}case"QUOTE":case"WRITE":case"CAR":case"CDR":case"LENGTH":case"SIN":case"COS":case"TAN":case"THIRD":case"LISTP":case"CONSP":case"NULL":case"NOT":case"NUMBERP":case"FUNCTION":{if(r.len(t)!=2)throw new d("expected one argument for "+a);if(a==="QUOTE")return t.cdr.car;if(a==="FUNCTION"){let n=t.cdr.car;if(n.type!=="ID")throw new d("expected ID");let o=n.data;if(!(o in this.functions))throw new d("undefined function "+o);return r.defun(o,this.functions[o])}let e=this.eval(t.cdr.car);switch(a){case"WRITE":return this.output+=e.toString(),console.log(e.toString()),e;case"CAR":case"CDR":case"LENGTH":if(e.type!=="CONS")throw new d(a+" expects a list");switch(a){case"CAR":return e.car;case"CDR":return e.cdr;case"LENGTH":let o=0;for(;e.type=="CONS";)o++,e=e.cdr;return r.atomINT(o)}case"SIN":case"COS":case"TAN":let n;switch(e.type==="INT"||e.type==="FLOAT"?n=e.data:e.type==="RATIO"?n=e.data.toFloat():new d(a+" expects a number"),a){case"SIN":return r.atomFLOAT(Math.sin(n));case"COS":return r.atomFLOAT(Math.cos(n));case"TAN":return r.atomFLOAT(Math.tan(n))}case"THIRD":return r.nth(e,2);case"LISTP":return e.type==="CONS"||e.type==="NIL"?r.atomT():r.atomNIL();case"CONSP":return e.type==="CONS"?r.atomT():r.atomNIL();case"NULL":case"NOT":return e.type==="NIL"?r.atomT():r.atomNIL();case"NUMBERP":return e.type==="INT"||e.type==="FLOAT"||e.type==="RATIO"?r.atomT():r.atomNIL()}}case"CONS":case"EQUALP":case"TYPEP":case"DEFPARAMETER":case"DEFCONSTANT":case"REMOVE":case"NTH":case"NTHCDR":{if(r.len(t)!=3)throw new d("expected two arguments for "+a);let e=t.cdr.car;["DEFPARAMETER","DEFCONSTANT"].includes(a)==!1&&(e=this.eval(e));let n=this.eval(t.cdr.cdr.car);switch(a){case"CONS":return r.cons(e,n);case"EQUALP":return r.equalp(e,n)?r.atomT():r.atomNIL();case"TYPEP":{if(n.type!=="ID")throw new d("expected ID as second param");switch(n.data){case"INTEGER":return e.type==="INT"?r.atomT():r.atomNIL();case"FLOAT":return e.type==="FLOAT"?r.atomT():r.atomNIL();case"RATIO":return e.type==="RATIO"?r.atomT():r.atomNIL();default:throw new d("unexpected TYPE "+n.data)}}case"DEFPARAMETER":case"DEFCONSTANT":{if(e.type!=="ID")throw new d("expected ID");let o=e.data;return this.variables[0][o]=n,a==="DEFCONSTANT"&&this.constants.add(o),r.global(o)}case"REMOVE":return n.remove(e);case"NTH":{if(e.type!=="INT"||e.data<0)throw new d("expected a non-negative integer index");return r.nth(n,e.data)}case"NTHCDR":{if(e.type!=="INT"||e.data<0)throw new d("expected a non-negative integer index");return r.nthcdr(n,e.data)}}}case"PROGN":{let e=r.atomNIL();for(let n=t.cdr;n.type==="CONS";n=n.cdr)e=this.eval(n.car);return e}case"LIST":{let e,n;e=n=r.atomNIL();for(let o=t.cdr,i=0;o.type==="CONS";o=o.cdr,i++){let u=this.eval(o.car),c=r.cons(u,r.atomNIL());i==0?e=n=c:(n.cdr=c,n=n.cdr)}return e}case"AND":{let e=r.atomT();for(let n=t.cdr;n.type==="CONS";n=n.cdr){let o=this.eval(n.car);if(o.type==="NIL")return o;e=o}return e}case"OR":{let e=r.atomNIL();for(let n=t.cdr;n.type==="CONS";n=n.cdr){let o=this.eval(n.car);if(o.type!=="NIL")return o;e=o}return e}case"+":case"*":{let e=r.atomINT(a==="+"?0:1);for(let n=t.cdr,o=0;n.type==="CONS";n=n.cdr,o++){let i=this.eval(n.car);if(e.type==="INT"&&i.type==="INT")a==="+"?e.data+=i.data:e.data*=i.data;else if(e.type==="INT"&&i.type==="RATIO"){let u=l.fromNumber(e.data),c=i.data;e.data=a==="+"?l.add(u,c):l.mul(u,c),e.type="RATIO"}else if(e.type==="RATIO"&&i.type==="INT"){let u=e.data,c=l.fromNumber(i.data);e.data=a==="+"?l.add(u,c):l.mul(u,c),e.type="RATIO"}else if(e.type==="RATIO"&&i.type==="RATIO"){let u=e.data,c=i.data;e.data=a==="+"?l.add(u,c):l.mul(u,c),e.type="RATIO"}else if(["INT","RATIO","FLOAT"].includes(e.type)&&["INT","RATIO","FLOAT"].includes(i.type)){let u=e.type==="RATIO"?e.data.toFloat():e.data,c=i.type==="RATIO"?i.data.toFloat():i.data;e.data=a==="+"?u+c:u*c,e.type="FLOAT"}else throw new d("incompatible types "+e.type+" and "+i.type+" for op "+a)}return e.type==="RATIO"&&e.data.denominator==1&&(e.data=e.data.numerator,e.type="INT"),e}case"-":case"/":{let e=r.atomINT(a==="-"?0:1);for(let n=t.cdr,o=0;n.type==="CONS";n=n.cdr,o++){let i=this.eval(n.car);if(o==0&&n.cdr.type!=="NIL")e.type=i.type,e.data=i.data;else if(e.type==="INT"&&i.type==="INT")if(a==="-")e.data-=i.data;else{let u=e.data,c=i.data;e.data=new l(u,c),e.type="RATIO"}else if(e.type==="INT"&&i.type==="RATIO"){let u;u=l.fromNumber(e.data);let c=i.data;e.data=a==="-"?l.sub(u,c):l.div(u,c),e.type="RATIO"}else if(e.type==="RATIO"&&i.type==="INT"){let u=e.data,c=l.fromNumber(i.data);e.data=a==="-"?l.sub(u,c):l.div(u,c),e.type="RATIO"}else if(e.type==="RATIO"&&i.type==="RATIO"){let u=e.data,c=i.data;e.data=a==="-"?l.sub(u,c):l.div(u,c),e.type="RATIO"}else if(["INT","RATIO","FLOAT"].includes(e.type)&&["INT","RATIO","FLOAT"].includes(i.type)){let u=e.type==="RATIO"?e.data.toFloat():i.data,c=i.type==="RATIO"?i.data.toFloat():i.data;e.data=a==="-"?u-c:u/c,e.type="FLOAT"}else throw new d("incompatible types "+e.type+" and "+i.type+" for op "+a)}return e.type==="RATIO"&&e.data.denominator==1&&(e.data=e.data.numerator,e.type="INT"),e}case"DOLIST":{let e=r.atomNIL(),n={};this.variables.push(n);let o=r.deepNth(t,[1,0]);if(o.type!=="ID")throw new d("expected ID");let i=this.eval(r.deepNth(t,[1,1])),u=r.nthcdr(t,2);for(;i.type!=="NIL";){n[o.data]=i.car;for(let c=u;c.type!=="NIL";c=c.cdr)this.eval(c.car);i=i.cdr}return this.variables.pop(),e}case">":case">=":case"<":case"<=":{let e=!0,n=a===">"||a===">="?1/0:-1/0,o;for(let i=t.cdr,u=0;i.type=="CONS";i=i.cdr,u++){let c=this.eval(i.car);switch(c.type){case"INT":let p=c.data;if(a===">"&&p>=n||a===">="&&p>n||a==="<"&&p<=n||a==="<="&&p<n){e=!1;break}else n=p;break;default:throw new d(c.toString()+" is not a number")}}if(o==0)throw new d("too few args");return e?r.atomT():r.atomNIL()}case"APPLY":case"FUNCALL":{let e=this.eval(t.cdr.car);if(e.type!=="DEFUN")throw new d("expected a function");let n={};this.variables.push(n);let o,i;for(o=t.cdr.cdr,a==="APPLY"&&(o=this.eval(o.car)),i=e.cdr.car;i.type!=="NIL";o=o.cdr,i=i.cdr){if(o.type==="NIL")throw new d("too few arguments");let c=i.car;if(c.type!=="ID")throw new d("parameter must be an ID");n[c.data]=this.eval(o.car)}if(o.type!=="NIL")throw new d("too many arguments");let u=r.atomNIL();for(let c=e.cdr.cdr;c.type!=="NIL";c=c.cdr)u=this.eval(c.car);return this.variables.pop(),u}default:{let e=this.functions[a];if(e==null)throw new d("unknown function "+a);let n={};this.variables.push(n);let o,i;for(o=t.cdr,i=e.car;i.type!=="NIL";o=o.cdr,i=i.cdr){if(o.type==="NIL")throw new d("too few arguments");let c=i.car;if(c.type!=="ID")throw new d("parameter must be an ID");n[c.data]=this.eval(o.car)}if(o.type!=="NIL")throw new d("too many arguments");let u=r.atomNIL();for(let c=e.cdr;c.type!=="NIL";c=c.cdr)u=this.eval(c.car);return this.variables.pop(),u}}case"INT":case"RATIO":case"FLOAT":case"STR":throw new d(""+t.car.data+" is not a function name");case"CONS":{let e=this.eval(t.car);if(e.type!=="DEFUN")throw new d("not a function");let n=e.cdr.car,o=t.cdr,i={};this.variables.push(i);let u,c;for(u=o,c=n;c.type!=="NIL";u=u.cdr,c=c.cdr){if(u.type==="NIL")throw new d("too few arguments");let m=c.car;if(m.type!=="ID")throw new d("parameter must be an ID");i[m.data]=this.eval(u.car)}if(u.type!=="NIL")throw new d("too many arguments");let p=r.atomNIL();for(let m=e.cdr.cdr;m.type!=="NIL";m=m.cdr)p=this.eval(m.car);return this.variables.pop(),p}default:throw new d("not allowed")}default:throw new d("unimplemented sexpr type "+t.type)}}},d=class extends Error{constructor(t){super("Error: "+t),this.name="RunError"}};return v(C);})();
