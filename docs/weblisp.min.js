"use strict";var weblisp=(()=>{var L=Object.defineProperty;var wt=Object.getOwnPropertyDescriptor;var bt=Object.getOwnPropertyNames;var yt=Object.prototype.hasOwnProperty;var gt=(o,t)=>{for(var r in t)L(o,r,{get:t[r],enumerable:!0})},Ot=(o,t,r,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of bt(t))!yt.call(o,i)&&i!==r&&L(o,i,{get:()=>t[i],enumerable:!(e=wt(t,i))||e.enumerable});return o};var At=o=>Ot(L({},"__esModule",{value:!0}),o);var Pt={};gt(Pt,{DebugInfo:()=>N,RunError:()=>s,WebLISP:()=>R});var S=class{constructor(t){this.src="";this.len=0;this.pos=0;this.token="";this.tokenRow=0;this.tokenCol=0;this.row=1;this.col=1;this.eof=!1;this.trsMode=!1;this.src=t,this.len=t.length,this.next()}getToken(){return this.token}getRow(){return this.tokenRow}getCol(){return this.tokenCol}isEof(){return this.eof}activateTrsMode(t=!0){this.trsMode=t}next(){let t=!1,r;for(;;){if(r=!1,this.pos>=this.len){this.eof=!0;return}switch(this.src[this.pos]){case" ":this.pos++,this.col++;break;case"	":this.pos++,this.col+=4;break;case`
`:this.pos++,this.row++,this.col=1,t&&(t=!1);break;case";":this.pos++,this.col++,t=!0;break;default:t?(this.pos++,this.col++):r=!0}if(r)break}this.tokenCol=this.col,this.tokenRow=this.row,this.token="";let e=!1;for(;;){if(this.pos>=this.len){this.token.length==0&&(this.eof=!0);return}let i=this.src[this.pos];if(i=='"')if(e){this.pos++,this.col++,this.token+=i;return}else{if(this.token.length>0)return;e=!0,this.pos++,this.col++,this.token+=i;continue}if(e==!1){if(` 	
;`.includes(i))return;if("()[]'`,".includes(i)){if(this.token.length>0&&this.token!=="#")return;this.pos++,this.col++,this.token+=i;return}}this.pos++,this.col++,e||this.token==="#\\"||this.trsMode?this.token+=i:this.token+=i.toUpperCase()}}};function Ct(o,t){for(;t!=0;){let r=t;t=o%t,o=r}return o}var d=class{constructor(t,r){this.numerator=t,this.denominator=r,this.reduce()}clone(){return new d(this.numerator,this.denominator)}reduce(){let t=Ct(this.numerator,this.denominator);this.numerator/=t,this.denominator/=t}compare(t){let r=this.clone();r.reduce();let e=t.clone();return e.reduce(),r.numerator==e.numerator&&r.denominator==e.denominator}static fromNumber(t){return new d(t,1)}static add(t,r){let e=new d(t.numerator*r.denominator+r.numerator*t.denominator,t.denominator*r.denominator);return e.reduce(),e}static sub(t,r){let e=new d(t.numerator*r.denominator-r.numerator*t.denominator,t.denominator*r.denominator);return e.reduce(),e}static mul(t,r){let e=new d(t.numerator*r.numerator,t.denominator*r.denominator);return e.reduce(),e}static div(t,r){let e=new d(t.numerator*r.denominator,t.denominator*r.numerator);return e.reduce(),e}toFloat(){return this.numerator/this.denominator}toString(){return""+this.numerator+"/"+this.denominator}};var n=class{constructor(t,r=-1,e=-1){this.car=null;this.cdr=null;this.srcRow=-1;this.srcCol=-1;this.type=t,this.srcRow=r,this.srcCol=e}set(t){this.type=t.type,this.data=t.data,this.car=t.car,this.cdr=t.cdr,this.srcRow=t.srcRow,this.srcCol=t.srcCol}static cons(t,r,e=-1,i=-1){let a=new n("CONS",e,i);return a.car=t,a.cdr=r,a.data=null,a}static defun(t,r,e=-1,i=-1){let a=new n("DEFUN",e,i);return a.car=n.atomID(t),a.cdr=r,a}static global(t,r=-1,e=-1){let i=new n("GLOBAL",r,e);return i.data=t,i}static atomNIL(t=-1,r=-1){return new n("NIL",t,r)}static atomINT(t,r=-1,e=-1){let i=new n("INT",r,e);return i.data=t,i}static atomRATIO(t,r,e=-1,i=-1){let a=new n("RATIO",e,i);return a.data=new d(t,r),a}static atomFLOAT(t,r=-1,e=-1){let i=new n("FLOAT",r,e);return i.data=t,i}static atomID(t,r=-1,e=-1){let i=new n("ID",r,e);return i.data=t,i}static atomCHAR(t,r=-1,e=-1){let i=new n("CHAR",r,e);return i.data=t,i}static atomSTRING(t,r=-1,e=-1){let i=new n("STR",r,e);return i.data=t,i}static atomT(t=-1,r=-1){return new n("T",t,r)}static len(t){let r=0;for(;t.type!=="NIL";)t=t.cdr,r++;return r}static nthcdr(t,r){let e=0;for(;t.type!=="NIL";){if(e==r)return t;t=t.cdr,e++}return n.atomNIL()}static nth(t,r){let e=0;for(;t.type!=="NIL";){if(e==r)return t.car;t=t.cdr,e++}return n.atomNIL()}static deepNth(t,r){let e=n.atomNIL();for(let i=0;i<r.length&&t.type!=="NIL";i++)e=t=n.nth(t,r[i]);return e}static equalp(t,r){if(t.type!==r.type)return!1;switch(t.type){case"T":case"NIL":return!0;case"CONS":if(n.equalp(t.car,r.car)==!1||n.equalp(t.cdr,r.cdr)==!1)return!1;break;case"INT":if(t.data!==r.data)return!1;break;case"FLOAT":let e=t.data,i=r.data;if(Math.abs(e-i)>1e-12)return!1;break;case"RATIO":if(t.data.compare(r.data)==!1)return!1;break;case"ID":case"CHAR":case"STR":if(t.data!==r.data)return!1;break;default:throw new Error("unimplemented SExpr.equalp(..) type "+t.type)}return!0}static match(t,r,e){if(t.type==="ID"){let i=t.data;if(i.startsWith("$")){let a=i.substring(1);if(a in e){if(n.equalp(e[a],r)==!1)return!1}else e[a]=r;return!0}}if(t.type==="CONS"&&t.car.type==="ID"){let i=t.car.data;if(i.startsWith("$$")){let a=i.substring(2);return a in e&&n.equalp(e[a],r)==!1?!1:(e[a]=r,!0)}}return t.type!==r.type?!1:t.type==="CONS"?n.match(t.car,r.car,e)&&n.match(t.cdr,r.cdr,e):t.data===r.data}remove(t){let r,e;r=n.atomNIL();let i=this,a=0;for(;i.type!=="NIL";){let c=i.car;c.type!=="CONS"&&c.type===t.type&&c.data===t.data||(a==0?r=e=n.cons(c,n.atomNIL()):(e.cdr=n.cons(c,n.atomNIL()),e=e.cdr)),i=i.cdr,a++}return r}static subst(t,r,e){return r.type==="CONS"?e:r.type===e.type&&r.data===e.data?t:e.type==="CONS"?n.cons(n.subst(t,r,e.car),n.subst(t,r,e.cdr)):e}static clone(t){if(t.type==="CONS")return n.cons(n.clone(t.car),n.clone(t.cdr),t.srcRow,t.srcCol);{let r=new n(t.type,t.srcRow,t.srcCol);return t.type==="RATIO"?r.data=t.data.clone():r.data=t.data,r}}static copyList(t){let r=n.atomNIL(),e=null,i=null;for(let a=t;a.type!="NIL";a=a.cdr)e=n.cons(a.car,n.atomNIL()),i==null?r=e:i.cdr=e,i=e;return r}static getLastCdr(t){let r=t;for(;t.type!=="NIL";)r=t,t=t.cdr;return r}toFloat(){switch(this.type){case"INT":case"FLOAT":return this.data;case"RATIO":return this.data.toFloat();default:return 0}}toCode(){switch(this.type){case"T":return"SExpr.atomT()";case"NIL":return"SExpr.atomNIL()";case"INT":case"FLOAT":return"SExpr.atomINT("+this.data+")";case"RATIO":return"SExpr.atomRATIO("+this.data.numerator+","+this.data.denominator+")";case"CONS":return"SExpr.cons("+this.car.toCode()+","+this.cdr.toCode()+")";default:throw Error("unimplemented SExpr.toCode() for type "+this.type)}}toString(t=!1,r=0){switch(this.type){case"NIL":return"NIL";case"T":return"T";case"INT":return""+this.data;case"FLOAT":return""+this.data;case"RATIO":return""+this.data.toString();case"ID":case"GLOBAL":return this.data;case"CHAR":return"#\\"+this.data;case"STR":return'"'+this.data+'"';case"DEFUN":return"FUNCTION "+this.car.data;case"CONS":let e="";if(t){e+=`
`;for(let c=0;c<r*2;c++)e+=" ";r++}e+="(";let i=this,a=0;do{if(i.type==="NIL")break;if(a>0&&(e+=" "),i.type!="CONS"){e+=". "+i.toString(t,r);break}e+=i.car.toString(t,r),i=i.cdr,a++}while(i!=null);return e+=")",r--,e;default:throw new Error("unimplemented")}}};var T=class{constructor(t){this.parser=null;this.parser=t}TRS_postprocess(t){let r=null,e=null;if(n.len(t)<2)throw new E("TRS has too few args",t.srcRow,t.srcCol);let i="s",a=[],c;for(let h=t.cdr;h.type!=="NIL";h=h.cdr){let m=h.car;switch(i){case"s":{c=new Set,a=this.TRS_extractTypeConditions(m),this.TRS_uppercase(m,!0,c),m=this.parser.generateUnaryCall("BACKQUOTE",m);let f=n.cons(m,n.atomNIL());r==null?r=e=f:(e.cdr=f,e=e.cdr),i="->";break}case"->":{if(m.type!=="ID"||m.data!=="->")throw new E("expected '->' while parsing TRS");let f=[];for(let l of a){let Rt=l.split(":")[0],w=l.split(":")[1];switch(w){case"number":f.push(n.cons(n.atomID("NUMBERP"),n.cons(n.atomID(Rt),n.atomNIL())));break;default:throw new E("condition has unknown type "+w)}}if(a.length==0){let l=n.cons(n.atomT(),n.atomNIL());e.cdr=l,e=e.cdr}else if(a.length==1){let l=n.cons(f[0],n.atomNIL());e.cdr=l,e=e.cdr}else{let l=n.cons(this.parser.generateCall("AND",f),n.atomNIL());e.cdr=l,e=e.cdr}i="t";break}case"t":{this.TRS_uppercase(m,!1,null),m=this.TRS_commaVariablesAndCommands(m,c),m=this.parser.generateUnaryCall("BACKQUOTE",m);let f=n.cons(m,n.atomNIL());e.cdr=f,e=e.cdr,i="s";break}}}return this.parser.generateUnaryCall("QUOTE",r)}TRS_extractTypeConditions(t){let r=[];switch(t.type){case"ID":{let e=t.data;e.includes(":")&&(r.push(e),t.data=e.split(":")[0]);break}case"CONS":r=r.concat(this.TRS_extractTypeConditions(t.car)),r=r.concat(this.TRS_extractTypeConditions(t.cdr));break}return r}TRS_uppercase(t,r,e){switch(t.type){case"ID":{let i=t.data;if(r&&i.length>0&&i[0]>="A"&&i[0]<="Z"&&i===i.toUpperCase()&&i!=="QUOTE"&&i!=="BACKQUOTE"&&i!=="COMMA"){let a=i.toUpperCase(),c=!1;a.endsWith("*")&&(c=!0,a=a.substring(0,a.length-1)),e.add(a),t.data=(c?"$$":"$")+a}else t.data=i.toUpperCase();break}case"CONS":this.TRS_uppercase(t.car,r,e),this.TRS_uppercase(t.cdr,r,e);break}}TRS_commaVariablesAndCommands(t,r,e=!1){switch(t.type){case"ID":{let i=t.data,a=!1;!e&&r.has(i)&&(t=this.parser.generateUnaryCall("COMMA",t));break}case"CONS":{t.car.type==="ID"&&t.car.data==="COMMA"&&(e=!0),t.car=this.TRS_commaVariablesAndCommands(t.car,r,e),t.cdr=this.TRS_commaVariablesAndCommands(t.cdr,r,e);break}}return t}};var E=class extends Error{constructor(t,r=-1,e=-1){r<0?super("Error: "+t):super("Error:"+r+":"+e+": "+t),this.name="ParseError"}},I=class{parse(t){let r=[];for(;!t.isEof();)r.push(this.parseSExpr(t));return r}parseSExpr(t){if(t.getToken()==="T"){let r=n.atomT(t.getRow(),t.getCol());return t.next(),r}else if(t.getToken()==="NIL"){let r=n.atomNIL(t.getRow(),t.getCol());return t.next(),r}else if(["#'","'","`",","].includes(t.getToken())){let r="";switch(t.getToken()){case"#'":r="FUNCTION";break;case"'":r="QUOTE";break;case"`":r="BACKQUOTE";break;case",":r="COMMA";break}return t.next(),this.generateUnaryCall(r,this.parseSExpr(t))}else if(t.getToken()==="("||t.getToken()==="["){let r=t.getToken()==="[";t.next();let e=!1;t.getToken()==="TRS"&&(e=!0,t.activateTrsMode(!0));let i=null,a=n.atomNIL(t.getRow(),t.getCol()),c=0,u=!1,h=0;for(;!t.isEof()&&t.getToken()!==")"&&t.getToken()!=="]";){let m=this.parseSExpr(t);if(m.type==="ID"&&m.data==="."){if(c==0)throw new E("'.' is not allowed here.",m.srcRow,m.srcCol);u=!0,h++;continue}if(u){i.cdr=m,u=!1;break}let f=n.cons(m,n.atomNIL(),m.srcRow,m.srcCol);c==0&&(a=f),i!=null&&(i.cdr=f),i=f,c++}if(u||h>1)throw new E("'.' is not allowed here.",t.getRow(),t.getCol());if(!r&&t.getToken()===")"||r&&t.getToken()==="]")t.next();else throw new E("expected '"+(r?"]":")")+"'",t.getRow(),t.getCol());return e&&(t.activateTrsMode(!1),a=new T(this).TRS_postprocess(a)),r?this.generateUnaryCall("COMMA",a):a}else if(t.getToken()==="."){let r=n.atomID(".",t.getRow(),t.getCol());return t.next(),r}else if(t.getToken()[0]>="0"&&t.getToken()[0]<="9"||t.getToken().length>1&&t.getToken()[0]=="-"&&t.getToken()[1]!=">"){let r=t.getToken(),e;return r.includes(".")?e=n.atomFLOAT(parseFloat(r),t.getRow(),t.getCol()):r.includes("/")?e=n.atomRATIO(parseInt(r.split("/")[0]),parseInt(r.split("/")[1]),t.getRow(),t.getCol()):e=n.atomINT(parseInt(r),t.getRow(),t.getCol()),t.next(),e}else if(t.getToken().startsWith("#\\")){let r=t.getToken(),e=n.atomCHAR(r.substring(2));return t.next(),e}else if(t.getToken()[0]=='"'){let r=t.getToken(),e=n.atomSTRING(r.substring(1,r.length-1));return t.next(),e}else{let r=t.getToken(),e=n.atomID(r,t.getRow(),t.getCol());return t.next(),e}}generateUnaryCall(t,r){return n.cons(n.atomID(t),n.cons(r,n.atomNIL(),r.srcRow,r.srcCol),r.srcRow,r.srcCol)}generateCall(t,r){let e=n.atomNIL();for(let i=r.length-1;i>=0;i--)e=n.cons(r[i],e);return n.cons(n.atomID(t),e)}};var b=`"use strict";var RUNTIME=(()=>{var d=Object.defineProperty;var l=Object.getOwnPropertyDescriptor;var h=Object.getOwnPropertyNames;var f=Object.prototype.hasOwnProperty;var I=(i,t)=>{for(var r in t)d(i,r,{get:t[r],enumerable:!0})},N=(i,t,r,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of h(t))!f.call(i,a)&&a!==r&&d(i,a,{get:()=>t[a],enumerable:!(e=l(t,a))||e.enumerable});return i};var b=i=>N(d({},"__esModule",{value:!0}),i);var R={};I(R,{Ratio:()=>o,SExpr:()=>n,SExprType:()=>m});var m=(c=>(c.CONS="CONS",c.NIL="NIL",c.INT="INT",c.RATIO="RATIO",c.FLOAT="FLOAT",c.ID="ID",c.CHAR="CHAR",c.STR="STR",c.T="T",c.DEFUN="DEFUN",c.GLOBAL="GLOBAL",c))(m||{});function p(i,t){for(;t!=0;){let r=t;t=i%t,i=r}return i}var o=class{constructor(t,r){this.numerator=t,this.denominator=r,this.reduce()}clone(){return new o(this.numerator,this.denominator)}reduce(){let t=p(this.numerator,this.denominator);this.numerator/=t,this.denominator/=t}compare(t){let r=this.clone();r.reduce();let e=t.clone();return e.reduce(),r.numerator==e.numerator&&r.denominator==e.denominator}static fromNumber(t){return new o(t,1)}static add(t,r){let e=new o(t.numerator*r.denominator+r.numerator*t.denominator,t.denominator*r.denominator);return e.reduce(),e}static sub(t,r){let e=new o(t.numerator*r.denominator-r.numerator*t.denominator,t.denominator*r.denominator);return e.reduce(),e}static mul(t,r){let e=new o(t.numerator*r.numerator,t.denominator*r.denominator);return e.reduce(),e}static div(t,r){let e=new o(t.numerator*r.denominator,t.denominator*r.numerator);return e.reduce(),e}toFloat(){return this.numerator/this.denominator}toString(){return""+this.numerator+"/"+this.denominator}};var n=class{constructor(t,r=-1,e=-1){this.car=null;this.cdr=null;this.srcRow=-1;this.srcCol=-1;this.type=t,this.srcRow=r,this.srcCol=e}set(t){this.type=t.type,this.data=t.data,this.car=t.car,this.cdr=t.cdr,this.srcRow=t.srcRow,this.srcCol=t.srcCol}static cons(t,r,e=-1,a=-1){let s=new n("CONS",e,a);return s.car=t,s.cdr=r,s.data=null,s}static defun(t,r,e=-1,a=-1){let s=new n("DEFUN",e,a);return s.car=n.atomID(t),s.cdr=r,s}static global(t,r=-1,e=-1){let a=new n("GLOBAL",r,e);return a.data=t,a}static atomNIL(t=-1,r=-1){return new n("NIL",t,r)}static atomINT(t,r=-1,e=-1){let a=new n("INT",r,e);return a.data=t,a}static atomRATIO(t,r,e=-1,a=-1){let s=new n("RATIO",e,a);return s.data=new o(t,r),s}static atomFLOAT(t,r=-1,e=-1){let a=new n("FLOAT",r,e);return a.data=t,a}static atomID(t,r=-1,e=-1){let a=new n("ID",r,e);return a.data=t,a}static atomCHAR(t,r=-1,e=-1){let a=new n("CHAR",r,e);return a.data=t,a}static atomSTRING(t,r=-1,e=-1){let a=new n("STR",r,e);return a.data=t,a}static atomT(t=-1,r=-1){return new n("T",t,r)}static len(t){let r=0;for(;t.type!=="NIL";)t=t.cdr,r++;return r}static nthcdr(t,r){let e=0;for(;t.type!=="NIL";){if(e==r)return t;t=t.cdr,e++}return n.atomNIL()}static nth(t,r){let e=0;for(;t.type!=="NIL";){if(e==r)return t.car;t=t.cdr,e++}return n.atomNIL()}static deepNth(t,r){let e=n.atomNIL();for(let a=0;a<r.length&&t.type!=="NIL";a++)e=t=n.nth(t,r[a]);return e}static equalp(t,r){if(t.type!==r.type)return!1;switch(t.type){case"T":case"NIL":return!0;case"CONS":if(n.equalp(t.car,r.car)==!1||n.equalp(t.cdr,r.cdr)==!1)return!1;break;case"INT":if(t.data!==r.data)return!1;break;case"FLOAT":let e=t.data,a=r.data;if(Math.abs(e-a)>1e-12)return!1;break;case"RATIO":if(t.data.compare(r.data)==!1)return!1;break;case"ID":case"CHAR":case"STR":if(t.data!==r.data)return!1;break;default:throw new Error("unimplemented SExpr.equalp(..) type "+t.type)}return!0}static match(t,r,e){if(t.type==="ID"){let a=t.data;if(a.startsWith("$")){let s=a.substring(1);if(s in e){if(n.equalp(e[s],r)==!1)return!1}else e[s]=r;return!0}}if(t.type==="CONS"&&t.car.type==="ID"){let a=t.car.data;if(a.startsWith("$$")){let s=a.substring(2);return s in e&&n.equalp(e[s],r)==!1?!1:(e[s]=r,!0)}}return t.type!==r.type?!1:t.type==="CONS"?n.match(t.car,r.car,e)&&n.match(t.cdr,r.cdr,e):t.data===r.data}remove(t){let r,e;r=n.atomNIL();let a=this,s=0;for(;a.type!=="NIL";){let u=a.car;u.type!=="CONS"&&u.type===t.type&&u.data===t.data||(s==0?r=e=n.cons(u,n.atomNIL()):(e.cdr=n.cons(u,n.atomNIL()),e=e.cdr)),a=a.cdr,s++}return r}static subst(t,r,e){return r.type==="CONS"?e:r.type===e.type&&r.data===e.data?t:e.type==="CONS"?n.cons(n.subst(t,r,e.car),n.subst(t,r,e.cdr)):e}static clone(t){if(t.type==="CONS")return n.cons(n.clone(t.car),n.clone(t.cdr),t.srcRow,t.srcCol);{let r=new n(t.type,t.srcRow,t.srcCol);return t.type==="RATIO"?r.data=t.data.clone():r.data=t.data,r}}static copyList(t){let r=n.atomNIL(),e=null,a=null;for(let s=t;s.type!="NIL";s=s.cdr)e=n.cons(s.car,n.atomNIL()),a==null?r=e:a.cdr=e,a=e;return r}static getLastCdr(t){let r=t;for(;t.type!=="NIL";)r=t,t=t.cdr;return r}toFloat(){switch(this.type){case"INT":case"FLOAT":return this.data;case"RATIO":return this.data.toFloat();default:return 0}}toCode(){switch(this.type){case"T":return"SExpr.atomT()";case"NIL":return"SExpr.atomNIL()";case"INT":case"FLOAT":return"SExpr.atomINT("+this.data+")";case"RATIO":return"SExpr.atomRATIO("+this.data.numerator+","+this.data.denominator+")";case"CONS":return"SExpr.cons("+this.car.toCode()+","+this.cdr.toCode()+")";default:throw Error("unimplemented SExpr.toCode() for type "+this.type)}}toString(t=!1,r=0){switch(this.type){case"NIL":return"NIL";case"T":return"T";case"INT":return""+this.data;case"FLOAT":return""+this.data;case"RATIO":return""+this.data.toString();case"ID":case"GLOBAL":return this.data;case"CHAR":return"#\\"+this.data;case"STR":return'"'+this.data+'"';case"DEFUN":return"FUNCTION "+this.car.data;case"CONS":let e="";if(t){e+="
";for(let u=0;u<r*2;u++)e+=" ";r++}e+="(";let a=this,s=0;do{if(a.type==="NIL")break;if(s>0&&(e+=" "),a.type!="CONS"){e+=". "+a.toString(t,r);break}e+=a.car.toString(t,r),a=a.cdr,s++}while(a!=null);return e+=")",r--,e;default:throw new Error("unimplemented")}}};return b(R);})();
`;function y(o){if(!this.interpret)throw new s("UNIMPLEMENTED");this.check&&this.checkArgCount(o,2);let t=this.eval(n.nth(o,1)),r=this.eval(n.nth(o,2)),e=t,i=[],a=[],c=[],u=r;for(;u.type!=="NIL";)i.push(this.eval(u.car)),u=u.cdr,a.push(u.car),u=u.cdr,c.push(u.car),u=u.cdr;let h=i.length;return this.runREWRITE_core(h,i,a,c,e)}function g(o,t,r,e,i){let a,c=0;do{a=!1,i.type==="CONS"&&(i.car=this.runREWRITE_core(o,t,r,e,i.car),i.cdr=this.runREWRITE_core(o,t,r,e,i.cdr));for(let u=0;u<o;u++){let h={};if(this.variables.push(h),n.match(t[u],i,h)&&this.eval(r[u]).type!=="NIL"){let f=i.toString();i=this.eval(n.clone(e[u])),i=this.runAPPEND_TILDE_core(i),console.log("REWROTE "+f+" -> "+i.toString()+" (USING RULE "+t[u].toString()+" -> "+e[u].toString()+")"),a=!0,c++}this.variables.pop()}}while(a);return i}function O(o){if(this.interpret){this.check&&this.checkArgCount(o,1);let t=this.eval(o.cdr.car);if(this.check&&t.type!=="CONS")throw new s("CAR expects a list");return t.car}else return n.atomSTRING(this.eval(o.cdr.car)+".car")}function A(o){if(this.interpret){this.check&&this.checkArgCount(o,1);let t=this.eval(o.cdr.car);if(this.check&&t.type!=="CONS")throw new s("CDR expects a list");return t.cdr}else return n.atomSTRING(this.eval(o.cdr.car)+".cdr")}function C(o){if(!this.interpret)throw new s("UNIMPLEMENTED");let t=n.atomT();for(let r=o.cdr;r.type==="CONS";r=r.cdr){let e=this.eval(r.car);if(e.type==="NIL")return e;t=e}return t}function P(o){if(!this.interpret)throw new s("UNIMPLEMENTED");let t=n.atomNIL(),r=t;for(let e=o.cdr;e.type!=="NIL";e=e.cdr){let i=this.eval(e.car);for(let a=i;a.type!=="NIL";a=a.cdr){let c=n.cons(a.car,n.atomNIL());t.type==="NIL"?t=r=c:(r.cdr=c,r=r.cdr)}}return t}function x(o){return this.check&&this.checkArgCount(o,1),this.runAPPEND_TILDE_core(this.eval(o.cdr.car))}function k(o){if(o.type!=="CONS")return o;let t=o,r;do{r=!1;let e=t,i=null;for(;e.type!="NIL";)if(e.car.type==="ID"&&e.car.data==="~"){if(r=!0,e.cdr.car.type!=="CONS"&&e.cdr.car.type!=="NIL")throw new s("append~ can only append lists");let a=n.copyList(e.cdr.car);if(e=e.cdr.cdr,a.type==="NIL")i==null?t=e:i.cdr=e;else{i==null?t=a:i.cdr=a;let c=n.getLastCdr(a);c!=null&&(i=c),i.cdr=e}}else i=e,e=e.cdr}while(r);for(let e=t;e.type!=="NIL";e=e.cdr)e.car.type==="CONS"&&(e.car=this.runAPPEND_TILDE_core(e.car));return t}function D(o){if(!this.interpret)throw new s("UNIMPLEMENTED");this.check&&this.checkMinArgCount(o,2);let t=this.eval(o.cdr.car);if(this.check&&t.type!=="DEFUN")throw new s("expected a function");let r=this.eval(o.cdr.cdr.car);return this.call(t.cdr.car,r,t.cdr.cdr)}function M(o){if(!this.interpret)throw new s("UNIMPLEMENTED");return this.check&&this.checkArgCount(o,1),this.eval(o.cdr.car).type!=="CONS"?n.atomT():n.atomNIL()}function U(o){if(!this.interpret)throw new s("UNIMPLEMENTED");return this.check&&this.checkArgCount(o,2),n.cons(this.eval(o.cdr.car),this.eval(o.cdr.cdr.car))}function v(o){if(!this.interpret)throw new s("UNIMPLEMENTED");this.check&&this.checkArgCount(o,2);let t=this.eval(o.cdr.car),r=this.eval(o.cdr.cdr.car);if(this.check&&t.type!=="STR")throw new s("Expected a string");if(this.check&&r.type!=="INT")throw new s("Expected an integer index");let e=t.data,i=r.data;if(this.check&&(i<0||i>=e.length))throw new s("invalid string index");return n.atomCHAR(e[i])}function W(o){if(!this.interpret)throw new s("UNIMPLEMENTED");return this.check&&this.checkArgCount(o,1),this.eval(o.cdr.car).type==="CONS"?n.atomT():n.atomNIL()}function F(o){if(!this.interpret)throw new s("UNIMPLEMENTED");this.check&&this.checkArgCount(o,1);let t=this.eval(o.cdr.car);return n.copyList(t)}function _(o){if(!this.interpret)throw new s("UNIMPLEMENTED");this.check&&this.checkArgCount(o,1);let t=this.eval(o.cdr.car);return this.check&&this.checkIsNumber(t),n.atomFLOAT(Math.cos(t.toFloat()))}function B(o,t){if(!this.interpret)throw new s("UNIMPLEMENTED");this.check&&this.checkArgCount(o,2);let r=o.cdr.car,e=this.eval(o.cdr.cdr.car);if(this.check&&r.type!=="ID")throw new s("expected ID");let i=r.data;return this.variables[0][i]=e,t&&this.constants.add(i),n.global(i)}function H(o){if(!this.interpret)throw new s("UNIMPLEMENTED");if(this.check&&(this.checkMinArgCount(o,2),n.nth(o,1).type!=="ID"||!(n.nth(o,2).type==="CONS"||n.nth(o,2).type==="NIL")))throw new s("DEFUN is not well structured");let t=n.nth(o,1).data,r=n.nthcdr(o,2);return this.functions[t]=r,n.defun(t,r)}function G(o){if(!this.interpret)throw new s("UNIMPLEMENTED");let t=n.atomNIL(),r={};this.variables.push(r);let e=n.nth(o,1),i=n.nth(o,2),a=n.nthcdr(o,3);if(this.check&&(e.type!=="CONS"||i.type!=="CONS"))throw new s("DO is not well structured");for(let c=e;c.type!=="NIL";c=c.cdr){let u=n.nth(c.car,0);if(this.check&&u.type!=="ID")throw new s("expected ID");let h=this.eval(n.nth(c.car,1));r[u.data]=h}for(;;){let c=!1;for(let u=0,h=i;h.type!=="NIL";u++,h=h.cdr){let m=this.eval(h.car);if(u==0)if(m.type==="T")c=!0;else break;u>0&&(t=m)}if(c)break;for(let u=a;u.type!=="NIL";u=u.cdr)this.eval(u.car);for(let u=e;u.type!=="NIL";u=u.cdr){let h=n.nth(u.car,0),m=this.eval(n.nth(u.car,2));r[h.data]=m}}return this.variables.pop(),t}function Q(o){if(!this.interpret)throw new s("UNIMPLEMENTED");let t=n.atomNIL(),r={};this.variables.push(r);let e=n.deepNth(o,[1,0]);if(this.check&&e.type!=="ID")throw new s("expected ID");let i=this.eval(n.deepNth(o,[1,1])),a=n.nthcdr(o,2);for(;i.type!=="NIL";){r[e.data]=i.car;for(let c=a;c.type!=="NIL";c=c.cdr)this.eval(c.car);i=i.cdr}return this.variables.pop(),t}function $(o){if(!this.interpret)throw new s("UNIMPLEMENTED");return this.check&&this.checkArgCount(o,2),n.equalp(this.eval(o.cdr.car),this.eval(o.cdr.cdr.car))?n.atomT():n.atomNIL()}function V(o){if(!this.interpret)throw new s("UNIMPLEMENTED");this.check&&this.checkMinArgCount(o,2);let t=this.eval(o.cdr.car);if(this.check&&t.type!=="DEFUN")throw new s("expected a function");return this.call(t.cdr.car,o.cdr.cdr,t.cdr.cdr)}function q(o){if(!this.interpret)throw new s("UNIMPLEMENTED");this.check&&this.checkArgCount(o,1);let t=o.cdr.car;if(this.check&&t.type!=="ID")throw new s("expected ID");let r=t.data;if(this.check&&!(r in this.functions))throw new s("undefined function "+r);return n.defun(r,this.functions[r])}function K(o){if(!this.interpret)throw new s("UNIMPLEMENTED");return this.checkMinArgCount(o,2),this.eval(n.nth(o,1)).type!=="NIL"?this.eval(n.nth(o,2)):this.eval(n.nth(o,3))}function Y(o){if(!this.interpret)throw new s("UNIMPLEMENTED");return n.defun("LAMBDA",n.nthcdr(o,1))}function j(o){if(this.interpret){this.check&&this.checkArgCount(o,1);let t=this.eval(o.cdr.car),r;for(r=0;t.type==="CONS";r++)t=t.cdr;return n.atomINT(r)}else{let t=this.genVar(),r=this.genVar(),e=this.eval(o.cdr.car),i=`let ${t}=${e};
let ${r};
for(${r}=0; ${t}.type === SExprType.CONS; ${r}++)
  ${t} = ${t}.cdr;
`;return this.code+=i,n.atomSTRING(`SExpr.atomINT(${r})`)}}function z(o){if(!this.interpret)throw new s("UNIMPLEMENTED");let t=n.atomNIL(),r={};this.variables.push(r);let e=n.nth(o,1),i=n.nthcdr(o,2);for(let a=e;a.type!=="NIL";a=a.cdr){if(this.check&&n.len(a.car)!=2)throw new s("expected (id init)");let c=n.nth(a.car,0);if(this.check&&c.type!=="ID")throw new s("expected ID");let u=this.eval(n.nth(a.car,1));r[c.data]=u}for(let a=i;a.type!=="NIL";a=a.cdr)t=this.eval(a.car);return this.variables.pop(),t}function Z(o){if(!this.interpret)throw new s("UNIMPLEMENTED");let t,r;t=r=n.atomNIL();for(let e=o.cdr,i=0;e.type==="CONS";e=e.cdr,i++){let a=this.eval(e.car),c=n.cons(a,n.atomNIL());i==0?t=r=c:(r.cdr=c,r=r.cdr)}return t}function J(o){if(!this.interpret)throw new s("UNIMPLEMENTED");this.check&&this.checkArgCount(o,1);let t=this.eval(o.cdr.car);return t.type==="CONS"||t.type==="NIL"?n.atomT():n.atomNIL()}function X(o){if(!this.interpret)throw new s("UNIMPLEMENTED");this.check&&this.checkArgCount(o,2);let t=this.eval(n.nth(o,1)),r=this.eval(n.nth(o,2)),e=n.atomNIL();for(let i=r;i.type!=="NIL";i=i.cdr)n.equalp(t,i.car)&&(e=i);return e}function tt(o){if(!this.interpret)throw new s("UNIMPLEMENTED");return this.check&&this.checkArgCount(o,1),this.eval(o.cdr.car).type==="NIL"?n.atomT():n.atomNIL()}function rt(o){if(!this.interpret)throw new s("UNIMPLEMENTED");this.check&&this.checkArgCount(o,2);let t=o.cdr.car,r=this.eval(o.cdr.cdr.car);if(this.check&&t.type!=="INT")throw new s("expected an integer index");let e=t.data;if(this.check&&e<0)throw new s("expected a non-negative integer index");return n.nth(r,e)}function et(o){if(!this.interpret)throw new s("UNIMPLEMENTED");this.check&&this.checkArgCount(o,2);let t=o.cdr.car,r=this.eval(o.cdr.cdr.car);if(this.check&&t.type!=="INT")throw new s("expected an integer index");let e=t.data;if(this.check&&e<0)throw new s("expected a non-negative integer index");return n.nthcdr(r,e)}function nt(o){if(!this.interpret)throw new s("UNIMPLEMENTED");return this.check&&this.checkArgCount(o,1),this.eval(o.cdr.car).type==="NIL"?n.atomT():n.atomNIL()}function ot(o){if(!this.interpret)throw new s("UNIMPLEMENTED");this.check&&this.checkArgCount(o,1);let t=this.eval(o.cdr.car);return t.type==="INT"||t.type==="FLOAT"||t.type==="RATIO"?n.atomT():n.atomNIL()}function it(o){if(!this.interpret)throw new s("UNIMPLEMENTED");let t=n.atomNIL();for(let r=o.cdr;r.type==="CONS";r=r.cdr){let e=this.eval(r.car);if(e.type!=="NIL")return e;t=e}return t}function at(o){if(!this.interpret)throw new s("UNIMPLEMENTED");let t=n.atomNIL();for(let r=o.cdr;r.type==="CONS";r=r.cdr)t=this.eval(r.car);return t}function st(o){return this.interpret?(this.check&&this.checkArgCount(o,1),o.cdr.car):n.atomSTRING(o.cdr.car.toCode())}function ct(o){if(!this.interpret)throw new s("UNIMPLEMENTED");this.check&&this.checkArgCount(o,2);let t=o.cdr.car;return this.eval(o.cdr.cdr.car).remove(t)}function ut(o){if(!this.interpret)throw new s("UNIMPLEMENTED");let t=n.len(o);this.check&&this.checkEvenArgCount(o);let r=n.atomNIL();for(let e=o.cdr;e.type!=="NIL";e=e.cdr.cdr)r=this.eval(e.car,!0),r.set(this.eval(e.cdr.car));return r}function pt(o){if(!this.interpret)throw new s("UNIMPLEMENTED");this.check&&this.checkArgCount(o,1);let t=this.eval(o.cdr.car);return this.check&&this.checkIsNumber(t),n.atomFLOAT(Math.sin(t.toFloat()))}function ht(o){if(!this.interpret)throw new s("UNIMPLEMENTED");this.check&&this.checkArgCount(o,3);let t=this.eval(n.nth(o,1)),r=this.eval(n.nth(o,2)),e=this.eval(n.nth(o,3));return n.subst(t,r,e)}function mt(o){if(!this.interpret)throw new s("UNIMPLEMENTED");this.check&&this.checkArgCount(o,1);let t=this.eval(o.cdr.car);return this.check&&this.checkIsNumber(t),n.atomFLOAT(Math.tan(t.toFloat()))}function dt(o){if(!this.interpret)throw new s("UNIMPLEMENTED");return this.output+=`
`,n.atomNIL()}function ft(o){if(!this.interpret)throw new s("UNIMPLEMENTED");this.check&&this.checkArgCount(o,1);let t=this.eval(o.cdr.car);return n.nth(t,2)}function Et(o){if(!this.interpret)throw new s("UNIMPLEMENTED");this.check&&this.checkArgCount(o,2);let t=this.eval(o.cdr.car),r=this.eval(o.cdr.cdr.car);if(this.check&&r.type!=="ID")throw new s("expected ID as second param");let e=r.data;if(this.check&&["INTEGER","FLOAT","RATIO"].includes(e)==!1)throw new s("unexpected TYPE "+e);if(t.type==="INT"&&e==="INTEGER"||t.type==="FLOAT"&&e==="FLOAT"||t.type==="RATIO"&&e==="RATIO")return n.atomT();n.atomNIL()}function lt(o){if(this.interpret){this.check&&this.checkArgCount(o,1);let t=this.eval(o.cdr.car);return this.output+=t.toString(),console.log(t.toString()),t}else{let t=this.genVar(),r=`let ${t} = ${this.eval(o.cdr.car)};`;return this.code+=r,this.code+=`console.log(${t}.toString());`,n.atomSTRING(t)}}function St(o,t){if(!this.interpret)throw new s("UNIMPLEMENTED");let r=n.atomINT(t==="+"?0:1);for(let e=o.cdr,i=0;e.type==="CONS";e=e.cdr,i++){let a=this.eval(e.car);if(r.type==="INT"&&a.type==="INT")t==="+"?r.data+=a.data:r.data*=a.data;else if(r.type==="INT"&&a.type==="RATIO"){let c=d.fromNumber(r.data),u=a.data;r.data=t==="+"?d.add(c,u):d.mul(c,u),r.type="RATIO"}else if(r.type==="RATIO"&&a.type==="INT"){let c=r.data,u=d.fromNumber(a.data);r.data=t==="+"?d.add(c,u):d.mul(c,u),r.type="RATIO"}else if(r.type==="RATIO"&&a.type==="RATIO"){let c=r.data,u=a.data;r.data=t==="+"?d.add(c,u):d.mul(c,u),r.type="RATIO"}else if(["INT","RATIO","FLOAT"].includes(r.type)&&["INT","RATIO","FLOAT"].includes(a.type)){let c=r.type==="RATIO"?r.data.toFloat():r.data,u=a.type==="RATIO"?a.data.toFloat():a.data;r.data=t==="+"?c+u:c*u,r.type="FLOAT"}else throw new s("incompatible types "+r.type+" and "+a.type+" for op "+t)}return r.type==="RATIO"&&r.data.denominator==1&&(r.data=r.data.numerator,r.type="INT"),r}function Tt(o,t){if(!this.interpret)throw new s("UNIMPLEMENTED");let r=n.atomINT(t==="-"?0:1);for(let e=o.cdr,i=0;e.type==="CONS";e=e.cdr,i++){let a=this.eval(e.car);if(i==0&&e.cdr.type!=="NIL")r.type=a.type,r.data=a.data;else if(r.type==="INT"&&a.type==="INT")if(t==="-")r.data-=a.data;else{let c=r.data,u=a.data;r.data=new d(c,u),r.type="RATIO"}else if(r.type==="INT"&&a.type==="RATIO"){let c;c=d.fromNumber(r.data);let u=a.data;r.data=t==="-"?d.sub(c,u):d.div(c,u),r.type="RATIO"}else if(r.type==="RATIO"&&a.type==="INT"){let c=r.data,u=d.fromNumber(a.data);r.data=t==="-"?d.sub(c,u):d.div(c,u),r.type="RATIO"}else if(r.type==="RATIO"&&a.type==="RATIO"){let c=r.data,u=a.data;r.data=t==="-"?d.sub(c,u):d.div(c,u),r.type="RATIO"}else if(["INT","RATIO","FLOAT"].includes(r.type)&&["INT","RATIO","FLOAT"].includes(a.type)){let c=r.type==="RATIO"?r.data.toFloat():a.data,u=a.type==="RATIO"?a.data.toFloat():a.data;r.data=t==="-"?c-u:c/u,r.type="FLOAT"}else throw new s("incompatible types "+r.type+" and "+a.type+" for op "+t)}return r.type==="RATIO"&&r.data.denominator==1&&(r.data=r.data.numerator,r.type="INT"),r}function It(o,t){if(!this.interpret)throw new s("UNIMPLEMENTED");let r=!0,e=t===">"||t===">="?1/0:-1/0,i;for(let a=o.cdr,c=0;a.type=="CONS";a=a.cdr,c++){let u=this.eval(a.car);switch(u.type){case"INT":let h=u.data;if(t===">"&&h>=e||t===">="&&h>e||t==="<"&&h<=e||t==="<="&&h<e){r=!1;break}else e=h;break;default:throw new s(u.toString()+" is not a number")}}if(i==0)throw new s("too few args");return r?n.atomT():n.atomNIL()}function Nt(o){if(!this.interpret)throw new s("UNIMPLEMENTED");return this.check&&this.checkArgCount(o,1),this.runBACKQUOTE_core(o.cdr.car)}function Lt(o){if(o.type==="CONS"){if(o.car.type==="ID"&&o.car.data==="COMMA")return this.eval(o.cdr.car);o.car=this.runBACKQUOTE_core(o.car),o.cdr=this.runBACKQUOTE_core(o.cdr)}return o}var N=class{constructor(){this.breakpointLine=0;this.col=0;this.variableValues={}}},s=class extends Error{constructor(t){super("Error: "+t),this.name="RunError"}},R=class{constructor(){this.interpret=!0;this.output="";this.program=[];this.code="";this.genVarCtr=0;this.functions={};this.variables=[{}];this.constants=new Set;this.startTime=0;this.maxSeconds=1/0;this.breakpoints=new Set;this.debugInfo=[];this.check=!0;this.run__PLUS__MUL=St;this.run__MINUS__DIV=Tt;this.run__COMPARE=It;this.runAND=C;this.runAPPEND=P;this.runAPPEND_TILDE=x;this.runAPPEND_TILDE_core=k;this.runAPPLY=D;this.runATOM=M;this.runBACKQUOTE=Nt;this.runBACKQUOTE_core=Lt;this.runCAR=O;this.runCDR=A;this.runCHAR=v;this.runCONS=U;this.runCONSP=W;this.runCOPY_LIST=F;this.runCOS=_;this.runDEFCONST_PARAM=B;this.runDEFUN=H;this.runDO=G;this.runDOLIST=Q;this.runEQUALP=$;this.runFUNCALL=V;this.runFUNCTION=q;this.runIF=K;this.runLAMBDA=Y;this.runLENGTH=j;this.runLET=z;this.runLIST=Z;this.runLISTP=J;this.runMEMBER=X;this.runNOT=tt;this.runNTH=rt;this.runNTHCDR=et;this.runNULL=nt;this.runNUMBERP=ot;this.runOR=it;this.runPROGN=at;this.runQUOTE=st;this.runREMOVE=ct;this.runREWRITE=y;this.runREWRITE_core=g;this.runSETF=ut;this.runSIN=pt;this.runSUBSTITUTE=ht;this.runTAN=mt;this.runTERPRI=dt;this.runTHIRD=ft;this.runTYPEP=Et;this.runWRITE=lt}import(t){let r=new S(t),e=new I;this.program=e.parse(r)}getOutput(){return this.output}getDebugInfo(){return this.debugInfo}addBreakpoint(t){this.breakpoints.add(t)}compile(){this.interpret=!1,this.genVarCtr=0;let t="";for(let r of this.program){this.code="";let e=this.eval(r);t+=this.code+e.data}return t=b+"var SExprType=RUNTIME.SExprType;var SExpr=RUNTIME.SExpr;"+t,t}run(t=!0,r=1/0){this.interpret=!0,this.output="",this.debugInfo=[],t&&(this.functions={},this.variables=[{}],this.constants=new Set),this.startTime=Date.now(),this.maxSeconds=r;let e=[];for(let i of this.program)e.push(this.eval(i));return e}genVar(){return"__"+this.genVarCtr++}eval(t,r=!1){if(this.breakpoints.size>0&&this.breakpoints.has(t.srcRow)){let i=new N;this.debugInfo.length>0&&this.debugInfo[this.debugInfo.length-1].breakpointLine==t.srcRow&&this.debugInfo[this.debugInfo.length-1].col!=t.srcCol&&this.debugInfo.pop(),this.debugInfo.push(i),i.breakpointLine=t.srcRow,i.col=t.srcCol;let a=this.variables.length;for(let c=a-1;c>=0;c--)for(let u in this.variables[c]){let h=this.variables[c][u].toString();u in i.variableValues||(i.variableValues[u]=h)}}if(this.maxSeconds!=1/0&&(Date.now()-this.startTime)/1e3>this.maxSeconds)throw new s("max allowed runtime exceeded!");let e="";switch(t.type){case"NIL":return this.interpret?t:n.atomSTRING("SExpr.atomNIL()");case"T":return this.interpret?t:n.atomSTRING("SExpr.atomT()");case"INT":return this.interpret?t:n.atomSTRING("SExpr.atomINT("+t.data+")");case"RATIO":return this.interpret?t:n.atomSTRING("SExpr.atomRATIO("+t.data.numerator+","+t.data.denominator+")");case"FLOAT":return this.interpret?t:n.atomSTRING("SExpr.atomFLOAT("+t.data+")");case"CHAR":return this.interpret?t:n.atomSTRING("SExpr.atomCHAR("+t.data+")");case"STR":return this.interpret?t:n.atomSTRING("SExpr.atomSTR("+t.data+")");case"ID":{if(!this.interpret)throw new s("case T.ID NOT IMPLEMENTED");let i=t.data,a=this.variables.length;for(let c=a-1;c>=0;c--)if(i in this.variables[c])return this.variables[c][i];if(r)return this.variables[a-1][i]=n.atomNIL(),this.variables[a-1][i];throw new s("unknown symbol "+i)}case"CONS":switch(t.car.type){case"INT":case"RATIO":case"FLOAT":case"STR":throw new s(""+t.car.data+" is not a function name");case"CONS":{if(!this.interpret)throw new s("UNIMPLEMENTED");let i=this.eval(t.car);if(this.check&&i.type!=="DEFUN")throw new s("not a function");return this.call(i.cdr.car,t.cdr,i.cdr.cdr)}case"ID":switch(e=t.car.data,e){case"+":case"*":return this.run__PLUS__MUL(t,e);case"-":case"/":return this.run__MINUS__DIV(t,e);case">":case">=":case"<":case"<=":return this.run__COMPARE(t,e);case"AND":return this.runAND(t);case"APPEND":return this.runAPPEND(t);case"APPEND~":return this.runAPPEND_TILDE(t);case"APPLY":return this.runAPPLY(t);case"ATOM":return this.runATOM(t);case"BACKQUOTE":return this.runBACKQUOTE(t);case"CAR":return this.runCAR(t);case"CDR":return this.runCDR(t);case"CHAR":return this.runCHAR(t);case"COMMA":throw new s("COMMA NOT ALLOWED OUTSIDE OF BACKQUOTE");case"CONS":return this.runCONS(t);case"CONSP":return this.runCONSP(t);case"COPY-LIST":return this.runCOPY_LIST(t);case"COS":return this.runCOS(t);case"DEFCONSTANT":return this.runDEFCONST_PARAM(t,!0);case"DEFPARAMETER":return this.runDEFCONST_PARAM(t,!1);case"DEFUN":return this.runDEFUN(t);case"DO":return this.runDO(t);case"DOLIST":return this.runDOLIST(t);case"EQUALP":return this.runEQUALP(t);case"FUNCALL":return this.runFUNCALL(t);case"FUNCTION":return this.runFUNCTION(t);case"IF":return this.runIF(t);case"LAMBDA":return this.runLAMBDA(t);case"LENGTH":return this.runLENGTH(t);case"LET":return this.runLET(t);case"LIST":return this.runLIST(t);case"LISTP":return this.runLISTP(t);case"MEMBER":return this.runMEMBER(t);case"NOT":return this.runNOT(t);case"NTH":return this.runNTH(t);case"NTHCDR":return this.runNTHCDR(t);case"NULL":return this.runNULL(t);case"NUMBERP":return this.runNUMBERP(t);case"OR":return this.runOR(t);case"PROGN":return this.runPROGN(t);case"QUOTE":return this.runQUOTE(t);case"REMOVE":return this.runREMOVE(t);case"REWRITE":return this.runREWRITE(t);case"SETF":return this.runSETF(t);case"SIN":return this.runSIN(t);case"SUBSTITUTE":case"SUBST":return this.runSUBSTITUTE(t);case"TAN":return this.runTAN(t);case"TERPRI":return this.runTERPRI(t);case"THIRD":return this.runTHIRD(t);case"TYPEP":return this.runTYPEP(t);case"WRITE":return this.runWRITE(t);default:{if(!this.interpret)throw new s("UNIMPLEMENTED");let i=this.functions[e];if(this.check&&i==null)throw new s("unknown function "+e);return this.call(i.car,t.cdr,i.cdr)}}default:throw new s("not allowed")}default:throw new s("unimplemented sexpr type "+t.type)}}call(t,r,e){let i={};this.variables.push(i);let a,c;for(a=r,c=t;c.type!=="NIL";a=a.cdr,c=c.cdr){if(this.check&&a.type==="NIL")throw new s("too few arguments");let h=c.car;if(this.check&&h.type!=="ID")throw new s("parameter must be an ID");i[h.data]=this.eval(a.car)}if(this.check&&a.type!=="NIL")throw new s("too many arguments");let u=n.atomNIL();for(;e.type!=="NIL";e=e.cdr)u=this.eval(e.car);return this.variables.pop(),u}checkArgCount(t,r){if(n.len(t)!=r+1)throw new s("expected "+r+" argument"+(r>0?"s":"#"))}checkMinArgCount(t,r){if(n.len(t)<r+1)throw new s("expected "+r+"+ argument"+(r>0?"s":"#"))}checkEvenArgCount(t){if((n.len(t)-1)%2!=0)throw new s("expected an even number of arguments")}checkIsNumber(t){if(t.type!=="INT"&&t.type!=="FLOAT"&&t.type!=="RATIO")throw new s("expected a number")}};return At(Pt);})();
