"use strict";var weblisp=(()=>{var w=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var g=Object.getOwnPropertyNames;var b=Object.prototype.hasOwnProperty;var O=(h,t)=>{for(var r in t)w(h,r,{get:t[r],enumerable:!0})},S=(h,t,r,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let e of g(t))!b.call(h,e)&&e!==r&&w(h,e,{get:()=>t[e],enumerable:!(a=L(t,e))||a.enumerable});return h};var A=h=>S(w({},"__esModule",{value:!0}),h);var v={};O(v,{RunError:()=>d,WebLISP:()=>R});var N=class{constructor(t){this.src="";this.len=0;this.pos=0;this.token="";this.tokenRow=0;this.tokenCol=0;this.row=1;this.col=1;this.eof=!1;this.src=t,this.len=t.length,this.next()}getToken(){return this.token}getRow(){return this.tokenRow}getCol(){return this.tokenCol}isEof(){return this.eof}next(){let t=!1,r=!1;for(;;){if(r=!1,this.pos>=this.len){this.eof=!0;return}let a=this.src[this.pos];switch(a){case" ":case"	":this.pos++,this.col+=a=="	"?4:1;break;case`
`:this.pos++,this.row++,this.col=1,t&&(t=!1);break;case";":this.pos++,this.col++,t=!0;break;default:t?(this.pos++,this.col++):r=!0}if(r)break}for(this.tokenCol=this.col,this.tokenRow=this.row,this.token="";;){if(this.pos>=this.len){this.token.length==0&&(this.eof=!0);return}let a=this.src[this.pos];if(a==" "||a=="	"||a==`
`||a==";")return;if(a=="("||a==")"||a=="'"){if(this.token!=="#"&&this.token.length>0)return;this.pos++,this.col++,this.token+=a;return}this.pos++,this.col++,this.token+=a.toUpperCase()}}};function E(h,t){for(;t!=0;){let r=t;t=h%t,h=r}return h}var l=class{constructor(t,r){this.numerator=t,this.denominator=r,this.reduce()}clone(){return new l(this.numerator,this.denominator)}reduce(){let t=E(this.numerator,this.denominator);this.numerator/=t,this.denominator/=t}compare(t){let r=this.clone();r.reduce();let a=t.clone();return a.reduce(),r.numerator==a.numerator&&r.denominator==a.denominator}static fromNumber(t){return new l(t,1)}static add(t,r){let a=new l(t.numerator*r.denominator+r.numerator*t.denominator,t.denominator*r.denominator);return a.reduce(),a}static sub(t,r){let a=new l(t.numerator*r.denominator-r.numerator*t.denominator,t.denominator*r.denominator);return a.reduce(),a}static mul(t,r){let a=new l(t.numerator*r.numerator,t.denominator*r.denominator);return a.reduce(),a}static div(t,r){let a=new l(t.numerator*r.denominator,t.denominator*r.numerator);return a.reduce(),a}toFloat(){return this.numerator/this.denominator}toString(){return""+this.numerator+"/"+this.denominator}};var s=class{constructor(t,r=-1,a=-1){this.car=null;this.cdr=null;this.srcRow=-1;this.srcCol=-1;this.type=t,this.srcRow=r,this.srcCol=a}set(t){this.type=t.type,this.data=t.data,this.car=t.car,this.cdr=t.cdr,this.srcRow=t.srcRow,this.srcCol=t.srcCol}static cons(t,r,a=-1,e=-1){let n=new s("CONS",a,e);return n.car=t,n.cdr=r,n}static defun(t,r,a=-1,e=-1){let n=new s("DEFUN",a,e);return n.car=s.atomID(t),n.cdr=r,n}static global(t,r=-1,a=-1){let e=new s("GLOBAL",r,a);return e.data=t,e}static atomNIL(t=-1,r=-1){return new s("NIL",t,r)}static atomINT(t,r=-1,a=-1){let e=new s("INT",r,a);return e.data=t,e}static atomRATIO(t,r,a=-1,e=-1){let n=new s("RATIO",a,e);return n.data=new l(t,r),n}static atomFLOAT(t,r=-1,a=-1){let e=new s("FLOAT",r,a);return e.data=t,e}static atomID(t,r=-1,a=-1){let e=new s("ID",r,a);return e.data=t,e}static atomSTRING(t,r=-1,a=-1){let e=new s("STR",r,a);return e.data=t,e}static atomT(t=-1,r=-1){return new s("T",t,r)}static len(t){let r=0;for(;t.type!=="NIL";)t=t.cdr,r++;return r}static rest(t,r){let a=0;for(;t.type!=="NIL";){if(a==r)return t;t=t.cdr,a++}return s.atomNIL()}static nth(t,r){let a=0;for(;t.type!=="NIL";){if(a==r)return t.car;t=t.cdr,a++}return s.atomNIL()}static deepNth(t,r){let a=s.atomNIL();for(let e=0;e<r.length&&t.type!=="NIL";e++)a=t=s.nth(t,r[e]);return a}static equalp(t,r){if(t.type!==r.type)return!1;switch(t.type){case"CONS":if(s.equalp(t.car,r.car)==!1||s.equalp(t.cdr,r.cdr)==!1)return!1;break;case"INT":if(t.data!==r.data)return!1;break;case"FLOAT":let a=t.data,e=r.data;if(Math.abs(a-e)>1e-12)return!1;break;case"RATIO":if(t.data.compare(r.data)==!1)return!1;break;case"ID":case"STR":if(t.data!==r.data)return!1;break}return!0}remove(t){let r,a;r=s.atomNIL();let e=this,n=0;for(;e.type!=="NIL";){let o=e.car;o.type!=="CONS"&&o.type===t.type&&o.data===t.data||(n==0?r=a=s.cons(o,s.atomNIL()):(a.cdr=s.cons(o,s.atomNIL()),a=a.cdr)),e=e.cdr,n++}return r}toString(){switch(this.type){case"NIL":return"NIL";case"T":return"T";case"INT":return""+this.data;case"FLOAT":return""+this.data;case"RATIO":return""+this.data.toString();case"ID":case"STR":case"GLOBAL":return this.data;case"DEFUN":return"FUNCTION "+this.car.data;case"CONS":let t="(",r=this,a=0;do{if(r.type==="NIL")break;if(a>0&&(t+=" "),r.type!="CONS"){t+=". "+r.toString();break}t+=r.car.toString(),r=r.cdr,a++}while(r!=null);return t+=")",t;default:throw new Error("unimplemented")}}};var T=class{static parse(t){let r=[];for(;!t.isEof();)r.push(this.parseRec(t));return r}static parseRec(t){if(t.getToken()==="T"){let r=s.atomT(t.getRow(),t.getCol());return t.next(),r}else if(t.getToken()==="NIL"){let r=s.atomNIL(t.getRow(),t.getCol());return t.next(),r}else if(t.getToken()==="#'"){t.next();let r=this.parseRec(t);return s.cons(s.atomID("FUNCTION"),s.cons(r,s.atomNIL()),t.getRow(),t.getCol())}else if(t.getToken()==="'"){t.next();let r=this.parseRec(t);return s.cons(s.atomID("QUOTE"),s.cons(r,s.atomNIL()),t.getRow(),t.getCol())}else if(t.getToken()==="("){t.next();let r=null,a=s.atomNIL(t.getRow(),t.getCol()),e=0,n=!1,o=0;for(;!t.isEof()&&t.getToken()!==")";){let i=this.parseRec(t);if(i.type==="ID"&&i.data==="."){if(e==0)throw new f("'.' is not allowed here.",i.srcRow,i.srcCol);n=!0,o++;continue}if(n){r.cdr=i,n=!1;break}let u=s.cons(i,s.atomNIL(),i.srcRow,i.srcCol);e==0&&(a=u),r!=null&&(r.cdr=u),r=u,e++}if(n||o>1)throw new f("'.' is not allowed here.",t.getRow(),t.getCol());if(t.getToken()===")")t.next();else throw new f("expected ')'",t.getRow(),t.getCol());return a}else if(t.getToken()==="."){let r=s.atomID(".",t.getRow(),t.getCol());return t.next(),r}else if(t.getToken()[0]>="0"&&t.getToken()[0]<="9"||t.getToken().length>1&&t.getToken()[0]=="-"){let r=t.getToken(),a;return r.includes(".")?a=s.atomFLOAT(parseFloat(r),t.getRow(),t.getCol()):r.includes("/")?a=s.atomRATIO(parseInt(r.split("/")[0]),parseInt(r.split("/")[1]),t.getRow(),t.getCol()):a=s.atomINT(parseInt(r),t.getRow(),t.getCol()),t.next(),a}else{let r=t.getToken(),a=s.atomID(r,t.getRow(),t.getCol());return t.next(),a}}},f=class extends Error{constructor(t,r=-1,a=-1){r<0?super("Error: "+t):super("Error:"+r+":"+a+": "+t),this.name="ParseError"}};var R=class{constructor(){this.output="";this.program=[];this.functions={};this.variables=[{}];this.constants=new Set;this.startTime=0;this.maxSeconds=1/0}import(t){let r=new N(t);this.program=T.parse(r)}getOutput(){return this.output}run(t=1/0){this.output="",this.functions={},this.variables=[{}],this.constants=new Set,this.startTime=Date.now(),this.maxSeconds=t;let r=[];for(let a of this.program)r.push(this.eval(a));return r}eval(t,r=!1){if(this.maxSeconds!=1/0&&(Date.now()-this.startTime)/1e3>this.maxSeconds)throw new d("max allowed runtime exceeded!");let a="";switch(t.type){case"NIL":case"T":case"INT":case"RATIO":case"FLOAT":return t;case"ID":{let e=t.data,n=this.variables.length;for(let o=n-1;o>=0;o--)if(e in this.variables[o])return this.variables[o][e];if(r)return this.variables[n-1][e]=s.atomNIL(),this.variables[n-1][e];throw new d("unknown symbol "+e)}case"CONS":switch(t.car.type){case"ID":switch(a=t.car.data,a){case"TERPRI":return this.output+=`
`,s.atomNIL();case"IF":{if(s.len(t)<3)throw new d("expected 2+ args for "+a);return this.eval(s.nth(t,1)).type!=="NIL"?this.eval(s.nth(t,2)):this.eval(s.nth(t,3))}case"LET":{let e=s.atomNIL(),n={};this.variables.push(n);let o=s.nth(t,1),i=s.rest(t,2);for(let u=o;u.type!=="NIL";u=u.cdr){if(s.len(u.car)!=2)throw new d("expected (id init)");let c=s.nth(u.car,0);if(c.type!=="ID")throw new d("expected ID");let p=this.eval(s.nth(u.car,1));n[c.data]=p}for(let u=i;u.type!=="NIL";u=u.cdr)e=this.eval(u.car);return this.variables.pop(),e}case"SETF":{if((s.len(t)-1)%2!=0)throw new d("SETF requires an even number of arguments");let n=s.atomNIL();for(let o=t.cdr;o.type!=="NIL";o=o.cdr){let i=o.car;n=this.eval(i,!0),o=o.cdr;let u=this.eval(o.car);n.set(u)}return n}case"DO":{let e=s.atomNIL(),n={};this.variables.push(n);let o=s.nth(t,1),i=s.nth(t,2),u=s.rest(t,3);if(o.type!=="CONS"||i.type!=="CONS")throw new d("DO is not well structured");for(let c=o;c.type!=="NIL";c=c.cdr){let p=s.nth(c.car,0);if(p.type!=="ID")throw new d("expected ID");let m=this.eval(s.nth(c.car,1));n[p.data]=m}for(;;){let c=!1;for(let p=0,m=i;m.type!=="NIL";p++,m=m.cdr){let I=this.eval(m.car);if(p==0)if(I.type==="T")c=!0;else break;p>0&&(e=I)}if(c)break;for(let p=u;p.type!=="NIL";p=p.cdr)this.eval(p.car);for(let p=o;p.type!=="NIL";p=p.cdr){let m=s.nth(p.car,0),I=this.eval(s.nth(p.car,2));n[m.data]=I}}return this.variables.pop(),e}case"DEFUN":{if(s.len(t)<3||s.nth(t,1).type!=="ID"||s.nth(t,2).type!=="CONS")throw new d("DEFUN is not well structured");let e=s.nth(t,1).data,n=s.rest(t,2);return this.functions[e]=n,s.defun(e,n)}case"LAMBDA":{let e=s.rest(t,1);return s.defun("LAMBDA",e)}case"QUOTE":case"WRITE":case"CAR":case"CDR":case"LENGTH":case"SIN":case"COS":case"TAN":case"THIRD":case"LISTP":case"CONSP":case"NULL":case"NOT":case"NUMBERP":case"FUNCTION":{if(s.len(t)!=2)throw new d("expected one argument for "+a);if(a==="QUOTE")return t.cdr.car;if(a==="FUNCTION"){let n=t.cdr.car;if(n.type!=="ID")throw new d("expected ID");let o=n.data;if(!(o in this.functions))throw new d("undefined function "+o);return s.defun(o,this.functions[o])}let e=this.eval(t.cdr.car);switch(a){case"WRITE":return this.output+=e.toString(),console.log(e.toString()),e;case"CAR":case"CDR":case"LENGTH":if(e.type!=="CONS")throw new d(a+" expects a list");switch(a){case"CAR":return e.car;case"CDR":return e.cdr;case"LENGTH":let o=0;for(;e.type=="CONS";)o++,e=e.cdr;return s.atomINT(o)}case"SIN":case"COS":case"TAN":let n;switch(e.type==="INT"||e.type==="FLOAT"?n=e.data:e.type==="RATIO"?n=e.data.toFloat():new d(a+" expects a number"),a){case"SIN":return s.atomFLOAT(Math.sin(n));case"COS":return s.atomFLOAT(Math.cos(n));case"TAN":return s.atomFLOAT(Math.tan(n))}case"THIRD":return s.nth(e,2);case"LISTP":return e.type==="CONS"||e.type==="NIL"?s.atomT():s.atomNIL();case"CONSP":return e.type==="CONS"?s.atomT():s.atomNIL();case"NULL":case"NOT":return e.type==="NIL"?s.atomT():s.atomNIL();case"NUMBERP":return e.type==="INT"||e.type==="FLOAT"||e.type==="RATIO"?s.atomT():s.atomNIL()}}case"CONS":case"EQUALP":case"TYPEP":case"DEFPARAMETER":case"DEFCONSTANT":case"REMOVE":case"NTH":{if(s.len(t)!=3)throw new d("expected two arguments for "+a);let e=t.cdr.car;["DEFPARAMETER","DEFCONSTANT"].includes(a)==!1&&(e=this.eval(e));let n=this.eval(t.cdr.cdr.car);switch(a){case"CONS":return s.cons(e,n);case"EQUALP":return s.equalp(e,n)?s.atomT():s.atomNIL();case"TYPEP":{if(n.type!=="ID")throw new d("expected ID as second param");switch(n.data){case"INTEGER":return e.type==="INT"?s.atomT():s.atomNIL();case"FLOAT":return e.type==="FLOAT"?s.atomT():s.atomNIL();case"RATIO":return e.type==="RATIO"?s.atomT():s.atomNIL();default:throw new d("unexpected TYPE "+n.data)}}case"DEFPARAMETER":case"DEFCONSTANT":{if(e.type!=="ID")throw new d("expected ID");let o=e.data;return this.variables[0][o]=n,a==="DEFCONSTANT"&&this.constants.add(o),s.global(o)}case"REMOVE":return n.remove(e);case"NTH":{if(e.type!=="INT"||e.data<0)throw new d("expected a non-negative integer index");return s.nth(n,e.data)}}}case"PROGN":{let e=s.atomNIL();for(let n=t.cdr;n.type==="CONS";n=n.cdr)e=this.eval(n.car);return e}case"LIST":{let e,n;e=n=s.atomNIL();for(let o=t.cdr,i=0;o.type==="CONS";o=o.cdr,i++){let u=this.eval(o.car),c=s.cons(u,s.atomNIL());i==0?e=n=c:(n.cdr=c,n=n.cdr)}return e}case"AND":{let e=s.atomT();for(let n=t.cdr;n.type==="CONS";n=n.cdr){let o=this.eval(n.car);if(o.type==="NIL")return o;e=o}return e}case"OR":{let e=s.atomNIL();for(let n=t.cdr;n.type==="CONS";n=n.cdr){let o=this.eval(n.car);if(o.type!=="NIL")return o;e=o}return e}case"+":case"*":{let e=s.atomINT(a==="+"?0:1);for(let n=t.cdr,o=0;n.type==="CONS";n=n.cdr,o++){let i=this.eval(n.car);if(e.type==="INT"&&i.type==="INT")a==="+"?e.data+=i.data:e.data*=i.data;else if(e.type==="INT"&&i.type==="RATIO"){let u=l.fromNumber(e.data),c=i.data;e.data=a==="+"?l.add(u,c):l.mul(u,c),e.type="RATIO"}else if(e.type==="RATIO"&&i.type==="INT"){let u=e.data,c=l.fromNumber(i.data);e.data=a==="+"?l.add(u,c):l.mul(u,c),e.type="RATIO"}else if(e.type==="RATIO"&&i.type==="RATIO"){let u=e.data,c=i.data;e.data=a==="+"?l.add(u,c):l.mul(u,c),e.type="RATIO"}else if(["INT","RATIO","FLOAT"].includes(e.type)&&["INT","RATIO","FLOAT"].includes(i.type)){let u=e.type==="RATIO"?e.data.toFloat():e.data,c=i.type==="RATIO"?i.data.toFloat():i.data;e.data=a==="+"?u+c:u*c,e.type="FLOAT"}else throw new d("incompatible types "+e.type+" and "+i.type+" for op "+a)}return e.type==="RATIO"&&e.data.denominator==1&&(e.data=e.data.numerator,e.type="INT"),e}case"-":case"/":{let e=s.atomINT(a==="-"?0:1);for(let n=t.cdr,o=0;n.type==="CONS";n=n.cdr,o++){let i=this.eval(n.car);if(o==0&&n.cdr.type!=="NIL")e.type=i.type,e.data=i.data;else if(e.type==="INT"&&i.type==="INT")if(a==="-")e.data-=i.data;else{let u=e.data,c=i.data;e.data=new l(u,c),e.type="RATIO"}else if(e.type==="INT"&&i.type==="RATIO"){let u;u=l.fromNumber(e.data);let c=i.data;e.data=a==="-"?l.sub(u,c):l.div(u,c),e.type="RATIO"}else if(e.type==="RATIO"&&i.type==="INT"){let u=e.data,c=l.fromNumber(i.data);e.data=a==="-"?l.sub(u,c):l.div(u,c),e.type="RATIO"}else if(e.type==="RATIO"&&i.type==="RATIO"){let u=e.data,c=i.data;e.data=a==="-"?l.sub(u,c):l.div(u,c),e.type="RATIO"}else if(["INT","RATIO","FLOAT"].includes(e.type)&&["INT","RATIO","FLOAT"].includes(i.type)){let u=e.type==="RATIO"?e.data.toFloat():i.data,c=i.type==="RATIO"?i.data.toFloat():i.data;e.data=a==="-"?u-c:u/c,e.type="FLOAT"}else throw new d("incompatible types "+e.type+" and "+i.type+" for op "+a)}return e.type==="RATIO"&&e.data.denominator==1&&(e.data=e.data.numerator,e.type="INT"),e}case"DOLIST":{let e=s.atomNIL(),n={};this.variables.push(n);let o=s.deepNth(t,[1,0]);if(o.type!=="ID")throw new d("expected ID");let i=this.eval(s.deepNth(t,[1,1])),u=s.rest(t,2);for(;i.type!=="NIL";){n[o.data]=i.car;for(let c=u;c.type!=="NIL";c=c.cdr)this.eval(c.car);i=i.cdr}return this.variables.pop(),e}case">":case">=":case"<":case"<=":{let e=!0,n=a===">"||a===">="?1/0:-1/0,o;for(let i=t.cdr,u=0;i.type=="CONS";i=i.cdr,u++){let c=this.eval(i.car);switch(c.type){case"INT":let p=c.data;if(a===">"&&p>=n||a===">="&&p>n||a==="<"&&p<=n||a==="<="&&p<n){e=!1;break}else n=p;break;default:throw new d(c.toString()+" is not a number")}}if(o==0)throw new d("too few args");return e?s.atomT():s.atomNIL()}case"APPLY":case"FUNCALL":{let e=this.eval(t.cdr.car);if(e.type!=="DEFUN")throw new d("expected a function");let n={};this.variables.push(n);let o,i;for(o=t.cdr.cdr,a==="APPLY"&&(o=this.eval(o.car)),i=e.cdr.car;i.type!=="NIL";o=o.cdr,i=i.cdr){if(o.type==="NIL")throw new d("too few arguments");let c=i.car;if(c.type!=="ID")throw new d("parameter must be an ID");n[c.data]=this.eval(o.car)}if(o.type!=="NIL")throw new d("too many arguments");let u=s.atomNIL();for(let c=e.cdr.cdr;c.type!=="NIL";c=c.cdr)u=this.eval(c.car);return this.variables.pop(),u}default:{let e=this.functions[a];if(e==null)throw new d("unknown function "+a);let n={};this.variables.push(n);let o,i;for(o=t.cdr,i=e.car;i.type!=="NIL";o=o.cdr,i=i.cdr){if(o.type==="NIL")throw new d("too few arguments");let c=i.car;if(c.type!=="ID")throw new d("parameter must be an ID");n[c.data]=this.eval(o.car)}if(o.type!=="NIL")throw new d("too many arguments");let u=s.atomNIL();for(let c=e.cdr;c.type!=="NIL";c=c.cdr)u=this.eval(c.car);return this.variables.pop(),u}}case"INT":case"RATIO":case"FLOAT":case"STR":throw new d(""+t.car.data+" is not a function name");case"CONS":{let e=this.eval(t.car);if(e.type!=="DEFUN")throw new d("not a function");let n=e.cdr.car,o=t.cdr,i={};this.variables.push(i);let u,c;for(u=o,c=n;c.type!=="NIL";u=u.cdr,c=c.cdr){if(u.type==="NIL")throw new d("too few arguments");let m=c.car;if(m.type!=="ID")throw new d("parameter must be an ID");i[m.data]=this.eval(u.car)}if(u.type!=="NIL")throw new d("too many arguments");let p=s.atomNIL();for(let m=e.cdr.cdr;m.type!=="NIL";m=m.cdr)p=this.eval(m.car);return this.variables.pop(),p}default:throw new d("not allowed")}default:throw new d("unimplemented sexpr type "+t.type)}}},d=class extends Error{constructor(t){super("Error: "+t),this.name="RunError"}};return A(v);})();
