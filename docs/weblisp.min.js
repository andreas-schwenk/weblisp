"use strict";var weblisp=(()=>{var S=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var O=Object.prototype.hasOwnProperty;var C=(p,t)=>{for(var a in t)S(p,a,{get:t[a],enumerable:!0})},A=(p,t,a,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let e of k(t))!O.call(p,e)&&e!==a&&S(p,e,{get:()=>t[e],enumerable:!(r=R(t,e))||r.enumerable});return p};var v=p=>A(S({},"__esModule",{value:!0}),p);var D={};C(D,{CompileError:()=>y,DebugInfo:()=>g,RunError:()=>c,WebLISP:()=>L});var N=class{constructor(t){this.src="";this.len=0;this.pos=0;this.token="";this.tokenRow=0;this.tokenCol=0;this.row=1;this.col=1;this.eof=!1;this.trsMode=!1;this.src=t,this.len=t.length,this.next()}getToken(){return this.token}getRow(){return this.tokenRow}getCol(){return this.tokenCol}isEof(){return this.eof}activateTrsMode(t=!0){this.trsMode=t}next(){let t=!1,a;for(;;){if(a=!1,this.pos>=this.len){this.eof=!0;return}switch(this.src[this.pos]){case" ":this.pos++,this.col++;break;case"	":this.pos++,this.col+=4;break;case`
`:this.pos++,this.row++,this.col=1,t&&(t=!1);break;case";":this.pos++,this.col++,t=!0;break;default:t?(this.pos++,this.col++):a=!0}if(a)break}this.tokenCol=this.col,this.tokenRow=this.row,this.token="";let r=!1;for(;;){if(this.pos>=this.len){this.token.length==0&&(this.eof=!0);return}let e=this.src[this.pos];if(e=='"')if(r){this.pos++,this.col++,this.token+=e;return}else{if(this.token.length>0)return;r=!0,this.pos++,this.col++,this.token+=e;continue}if(r==!1){if(e==" "||e=="	"||e==`
`||e==";")return;if(e=="("||e==")"||e=="["||e=="]"||e=="'"||e=="`"||e==","){if(this.token.length>0&&this.token!=="#")return;this.pos++,this.col++,this.token+=e;return}}this.pos++,this.col++,r||this.token==="#\\"||this.trsMode?this.token+=e:this.token+=e.toUpperCase()}}};function M(p,t){for(;t!=0;){let a=t;t=p%t,p=a}return p}var l=class{constructor(t,a){this.numerator=t,this.denominator=a,this.reduce()}clone(){return new l(this.numerator,this.denominator)}reduce(){let t=M(this.numerator,this.denominator);this.numerator/=t,this.denominator/=t}compare(t){let a=this.clone();a.reduce();let r=t.clone();return r.reduce(),a.numerator==r.numerator&&a.denominator==r.denominator}static fromNumber(t){return new l(t,1)}static add(t,a){let r=new l(t.numerator*a.denominator+a.numerator*t.denominator,t.denominator*a.denominator);return r.reduce(),r}static sub(t,a){let r=new l(t.numerator*a.denominator-a.numerator*t.denominator,t.denominator*a.denominator);return r.reduce(),r}static mul(t,a){let r=new l(t.numerator*a.numerator,t.denominator*a.denominator);return r.reduce(),r}static div(t,a){let r=new l(t.numerator*a.denominator,t.denominator*a.numerator);return r.reduce(),r}toFloat(){return this.numerator/this.denominator}toString(){return""+this.numerator+"/"+this.denominator}};var n=class{constructor(t,a=-1,r=-1){this.car=null;this.cdr=null;this.srcRow=-1;this.srcCol=-1;this.type=t,this.srcRow=a,this.srcCol=r}set(t){this.type=t.type,this.data=t.data,this.car=t.car,this.cdr=t.cdr,this.srcRow=t.srcRow,this.srcCol=t.srcCol}static cons(t,a,r=-1,e=-1){let i=new n("CONS",r,e);return i.car=t,i.cdr=a,i.data=null,i}static defun(t,a,r=-1,e=-1){let i=new n("DEFUN",r,e);return i.car=n.atomID(t),i.cdr=a,i}static global(t,a=-1,r=-1){let e=new n("GLOBAL",a,r);return e.data=t,e}static atomNIL(t=-1,a=-1){return new n("NIL",t,a)}static atomINT(t,a=-1,r=-1){let e=new n("INT",a,r);return e.data=t,e}static atomRATIO(t,a,r=-1,e=-1){let i=new n("RATIO",r,e);return i.data=new l(t,a),i}static atomFLOAT(t,a=-1,r=-1){let e=new n("FLOAT",a,r);return e.data=t,e}static atomID(t,a=-1,r=-1){let e=new n("ID",a,r);return e.data=t,e}static atomCHAR(t,a=-1,r=-1){let e=new n("CHAR",a,r);return e.data=t,e}static atomSTRING(t,a=-1,r=-1){let e=new n("STR",a,r);return e.data=t,e}static atomT(t=-1,a=-1){return new n("T",t,a)}static len(t){let a=0;for(;t.type!=="NIL";)t=t.cdr,a++;return a}static nthcdr(t,a){let r=0;for(;t.type!=="NIL";){if(r==a)return t;t=t.cdr,r++}return n.atomNIL()}static nth(t,a){let r=0;for(;t.type!=="NIL";){if(r==a)return t.car;t=t.cdr,r++}return n.atomNIL()}static deepNth(t,a){let r=n.atomNIL();for(let e=0;e<a.length&&t.type!=="NIL";e++)r=t=n.nth(t,a[e]);return r}static equalp(t,a){if(t.type!==a.type)return!1;switch(t.type){case"T":case"NIL":return!0;case"CONS":if(n.equalp(t.car,a.car)==!1||n.equalp(t.cdr,a.cdr)==!1)return!1;break;case"INT":if(t.data!==a.data)return!1;break;case"FLOAT":let r=t.data,e=a.data;if(Math.abs(r-e)>1e-12)return!1;break;case"RATIO":if(t.data.compare(a.data)==!1)return!1;break;case"ID":case"CHAR":case"STR":if(t.data!==a.data)return!1;break;default:throw new Error("unimplemented SExpr.equalp(..) type "+t.type)}return!0}static match(t,a,r){if(t.type==="ID"){let e=t.data;if(e.startsWith("$")){let i=e.substring(1);if(i in r){if(n.equalp(r[i],a)==!1)return!1}else r[i]=a;return!0}}if(t.type==="CONS"&&t.car.type==="ID"){let e=t.car.data;if(e.startsWith("$$")){let i=e.substring(2);return i in r&&n.equalp(r[i],a)==!1?!1:(r[i]=a,!0)}}return t.type!==a.type?!1:t.type==="CONS"?n.match(t.car,a.car,r)&&n.match(t.cdr,a.cdr,r):t.data===a.data}remove(t){let a,r;a=n.atomNIL();let e=this,i=0;for(;e.type!=="NIL";){let s=e.car;s.type!=="CONS"&&s.type===t.type&&s.data===t.data||(i==0?a=r=n.cons(s,n.atomNIL()):(r.cdr=n.cons(s,n.atomNIL()),r=r.cdr)),e=e.cdr,i++}return a}static subst(t,a,r){return a.type==="CONS"?r:a.type===r.type&&a.data===r.data?t:r.type==="CONS"?n.cons(n.subst(t,a,r.car),n.subst(t,a,r.cdr)):r}toFloat(){switch(this.type){case"INT":case"FLOAT":return this.data;case"RATIO":return this.data.toFloat();default:return 0}}toCode(){switch(this.type){case"T":return"SExpr.atomT()";case"NIL":return"SExpr.atomNIL()";case"INT":case"FLOAT":return"SExpr.atomINT("+this.data+")";case"RATIO":return"SExpr.atomRATIO("+this.data.numerator+","+this.data.denominator+")";case"CONS":return"SExpr.cons("+this.car.toCode()+","+this.cdr.toCode()+")";default:throw Error("unimplemented SExpr.toCode() for type "+this.type)}}toString(t=!1,a=0){switch(this.type){case"NIL":return"NIL";case"T":return"T";case"INT":return""+this.data;case"FLOAT":return""+this.data;case"RATIO":return""+this.data.toString();case"ID":case"GLOBAL":return this.data;case"CHAR":return"#\\"+this.data;case"STR":return'"'+this.data+'"';case"DEFUN":return"FUNCTION "+this.car.data;case"CONS":let r="";if(t){r+=`
`;for(let s=0;s<a*2;s++)r+=" ";a++}r+="(";let e=this,i=0;do{if(e.type==="NIL")break;if(i>0&&(r+=" "),e.type!="CONS"){r+=". "+e.toString(t,a);break}r+=e.car.toString(t,a),e=e.cdr,i++}while(e!=null);return r+=")",a--,r;default:throw new Error("unimplemented")}}};var w=class{constructor(t){this.parser=null;this.parser=t}TRS_postprocess(t){let a=n.cons(n.atomID("REWRITE"),n.atomNIL()),r=a;if(n.len(t)<2)throw new m("TRS has too few args",t.srcRow,t.srcCol);let e="input",i=[],s;for(let o=t.cdr;o.type!=="NIL";o=o.cdr){let h=o.car;switch(e){case"input":{this.TRS_uppercase(h,!1,null),r.cdr=n.cons(h,n.atomNIL()),r=r.cdr,e="s";break}case"s":{s=new Set,i=this.TRS_extractTypeConditions(h),this.TRS_uppercase(h,!0,s),h=this.parser.embedIntoId("BACKQUOTE",h),r.cdr=n.cons(h,n.atomNIL()),r=r.cdr,e="->";break}case"->":{if(h.type!=="ID"||h.data!=="->")throw new m("expected '->' while parsing TRS");let u=[];for(let d of i){let f=d.split(":")[0],I=d.split(":")[1];switch(I){case"number":u.push(n.cons(n.atomID("NUMBERP"),n.cons(n.atomID(f),n.atomNIL())));break;default:throw new m("condition has unknown type "+I)}}if(i.length==0)r.cdr=n.cons(n.atomT(),n.atomNIL()),r=r.cdr;else if(i.length==1)r.cdr=n.cons(u[0],n.atomNIL()),r=r.cdr;else{let d=n.cons(this.parser.generateCall("AND",u),n.atomNIL());r.cdr=d,r=r.cdr}e="t";break}case"t":{this.TRS_uppercase(h,!1,null),h=this.TRS_commaVariablesAndCommands(h,s),h=this.parser.embedIntoId("BACKQUOTE",h),r.cdr=n.cons(h,n.atomNIL()),r=r.cdr,e="s";break}}}return console.log(a.toString(!0)),a}TRS_extractTypeConditions(t){let a=[];switch(t.type){case"ID":{let r=t.data;r.includes(":")&&(a.push(r),t.data=r.split(":")[0]);break}case"CONS":a=a.concat(this.TRS_extractTypeConditions(t.car)),a=a.concat(this.TRS_extractTypeConditions(t.cdr));break}return a}TRS_uppercase(t,a,r){switch(t.type){case"ID":{let e=t.data;if(a&&e.length>0&&e[0]>="A"&&e[0]<="Z"&&e===e.toUpperCase()&&e!=="QUOTE"&&e!=="BACKQUOTE"&&e!=="COMMA"){let i=e.toUpperCase(),s=!1;i.endsWith("*")&&(s=!0,i=i.substring(0,i.length-1)),r.add(i),t.data=(s?"$$":"$")+i}else t.data=e.toUpperCase();break}case"CONS":this.TRS_uppercase(t.car,a,r),this.TRS_uppercase(t.cdr,a,r);break}}TRS_commaVariablesAndCommands(t,a,r=!1){switch(t.type){case"ID":{let e=t.data,i=!1;!r&&a.has(e)&&(t=this.parser.embedIntoId("COMMA",t));break}case"CONS":{t.car.type==="ID"&&t.car.data==="COMMA"&&(r=!0),t.car=this.TRS_commaVariablesAndCommands(t.car,a,r),t.cdr=this.TRS_commaVariablesAndCommands(t.cdr,a,r);break}}return t}};var E=class{parse(t){let a=[];for(;!t.isEof();)a.push(this.parseSExpr(t));return a}parseSExpr(t){if(t.getToken()==="T"){let a=n.atomT(t.getRow(),t.getCol());return t.next(),a}else if(t.getToken()==="NIL"){let a=n.atomNIL(t.getRow(),t.getCol());return t.next(),a}else if(["#'","'","`",","].includes(t.getToken())){let a="";switch(t.getToken()){case"#'":a="FUNCTION";break;case"'":a="QUOTE";break;case"`":a="BACKQUOTE";break;case",":a="COMMA";break}t.next();let r=this.parseSExpr(t);return n.cons(n.atomID(a),n.cons(r,n.atomNIL()),t.getRow(),t.getCol())}else if(t.getToken()==="("||t.getToken()==="["){let a=t.getToken()==="[";t.next();let r=!1;t.getToken()==="TRS"&&(r=!0,t.activateTrsMode(!0));let e=null,i=n.atomNIL(t.getRow(),t.getCol()),s=0,o=!1,h=0;for(;!t.isEof()&&t.getToken()!==")"&&t.getToken()!=="]";){let u=this.parseSExpr(t);if(u.type==="ID"&&u.data==="."){if(s==0)throw new m("'.' is not allowed here.",u.srcRow,u.srcCol);o=!0,h++;continue}if(o){e.cdr=u,o=!1;break}let d=n.cons(u,n.atomNIL(),u.srcRow,u.srcCol);s==0&&(i=d),e!=null&&(e.cdr=d),e=d,s++}if(o||h>1)throw new m("'.' is not allowed here.",t.getRow(),t.getCol());if(!a&&t.getToken()===")"||a&&t.getToken()==="]")t.next();else throw new m("expected '"+(a?"]":")")+"'",t.getRow(),t.getCol());return r&&(t.activateTrsMode(!1),i=new w(this).TRS_postprocess(i)),a?this.embedIntoId("COMMA",i):i}else if(t.getToken()==="."){let a=n.atomID(".",t.getRow(),t.getCol());return t.next(),a}else if(t.getToken()[0]>="0"&&t.getToken()[0]<="9"||t.getToken().length>1&&t.getToken()[0]=="-"&&t.getToken()[1]!=">"){let a=t.getToken(),r;return a.includes(".")?r=n.atomFLOAT(parseFloat(a),t.getRow(),t.getCol()):a.includes("/")?r=n.atomRATIO(parseInt(a.split("/")[0]),parseInt(a.split("/")[1]),t.getRow(),t.getCol()):r=n.atomINT(parseInt(a),t.getRow(),t.getCol()),t.next(),r}else if(t.getToken().startsWith("#\\")){let a=t.getToken(),r=n.atomCHAR(a.substring(2));return t.next(),r}else if(t.getToken()[0]=='"'){let a=t.getToken(),r=n.atomSTRING(a.substring(1,a.length-1));return t.next(),r}else{let a=t.getToken(),r=n.atomID(a,t.getRow(),t.getCol());return t.next(),r}}embedIntoId(t,a){return n.cons(n.atomID(t),n.cons(a,n.atomNIL()),a.srcRow,a.srcCol)}generateCall(t,a){let r=n.atomNIL();for(let e=a.length-1;e>=0;e--)r=n.cons(a[e],r);return n.cons(n.atomID(t),r)}},m=class extends Error{constructor(t,a=-1,r=-1){a<0?super("Error: "+t):super("Error:"+a+":"+r+": "+t),this.name="ParseError"}};var b=`"use strict";var RUNTIME=(()=>{var d=Object.defineProperty;var l=Object.getOwnPropertyDescriptor;var h=Object.getOwnPropertyNames;var f=Object.prototype.hasOwnProperty;var I=(i,t)=>{for(var r in t)d(i,r,{get:t[r],enumerable:!0})},N=(i,t,r,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of h(t))!f.call(i,a)&&a!==r&&d(i,a,{get:()=>t[a],enumerable:!(e=l(t,a))||e.enumerable});return i};var b=i=>N(d({},"__esModule",{value:!0}),i);var p={};I(p,{Ratio:()=>o,SExpr:()=>n,SExprType:()=>m});var m=(c=>(c.CONS="CONS",c.NIL="NIL",c.INT="INT",c.RATIO="RATIO",c.FLOAT="FLOAT",c.ID="ID",c.CHAR="CHAR",c.STR="STR",c.T="T",c.DEFUN="DEFUN",c.GLOBAL="GLOBAL",c))(m||{});function R(i,t){for(;t!=0;){let r=t;t=i%t,i=r}return i}var o=class{constructor(t,r){this.numerator=t,this.denominator=r,this.reduce()}clone(){return new o(this.numerator,this.denominator)}reduce(){let t=R(this.numerator,this.denominator);this.numerator/=t,this.denominator/=t}compare(t){let r=this.clone();r.reduce();let e=t.clone();return e.reduce(),r.numerator==e.numerator&&r.denominator==e.denominator}static fromNumber(t){return new o(t,1)}static add(t,r){let e=new o(t.numerator*r.denominator+r.numerator*t.denominator,t.denominator*r.denominator);return e.reduce(),e}static sub(t,r){let e=new o(t.numerator*r.denominator-r.numerator*t.denominator,t.denominator*r.denominator);return e.reduce(),e}static mul(t,r){let e=new o(t.numerator*r.numerator,t.denominator*r.denominator);return e.reduce(),e}static div(t,r){let e=new o(t.numerator*r.denominator,t.denominator*r.numerator);return e.reduce(),e}toFloat(){return this.numerator/this.denominator}toString(){return""+this.numerator+"/"+this.denominator}};var n=class{constructor(t,r=-1,e=-1){this.car=null;this.cdr=null;this.srcRow=-1;this.srcCol=-1;this.type=t,this.srcRow=r,this.srcCol=e}set(t){this.type=t.type,this.data=t.data,this.car=t.car,this.cdr=t.cdr,this.srcRow=t.srcRow,this.srcCol=t.srcCol}static cons(t,r,e=-1,a=-1){let s=new n("CONS",e,a);return s.car=t,s.cdr=r,s.data=null,s}static defun(t,r,e=-1,a=-1){let s=new n("DEFUN",e,a);return s.car=n.atomID(t),s.cdr=r,s}static global(t,r=-1,e=-1){let a=new n("GLOBAL",r,e);return a.data=t,a}static atomNIL(t=-1,r=-1){return new n("NIL",t,r)}static atomINT(t,r=-1,e=-1){let a=new n("INT",r,e);return a.data=t,a}static atomRATIO(t,r,e=-1,a=-1){let s=new n("RATIO",e,a);return s.data=new o(t,r),s}static atomFLOAT(t,r=-1,e=-1){let a=new n("FLOAT",r,e);return a.data=t,a}static atomID(t,r=-1,e=-1){let a=new n("ID",r,e);return a.data=t,a}static atomCHAR(t,r=-1,e=-1){let a=new n("CHAR",r,e);return a.data=t,a}static atomSTRING(t,r=-1,e=-1){let a=new n("STR",r,e);return a.data=t,a}static atomT(t=-1,r=-1){return new n("T",t,r)}static len(t){let r=0;for(;t.type!=="NIL";)t=t.cdr,r++;return r}static nthcdr(t,r){let e=0;for(;t.type!=="NIL";){if(e==r)return t;t=t.cdr,e++}return n.atomNIL()}static nth(t,r){let e=0;for(;t.type!=="NIL";){if(e==r)return t.car;t=t.cdr,e++}return n.atomNIL()}static deepNth(t,r){let e=n.atomNIL();for(let a=0;a<r.length&&t.type!=="NIL";a++)e=t=n.nth(t,r[a]);return e}static equalp(t,r){if(t.type!==r.type)return!1;switch(t.type){case"T":case"NIL":return!0;case"CONS":if(n.equalp(t.car,r.car)==!1||n.equalp(t.cdr,r.cdr)==!1)return!1;break;case"INT":if(t.data!==r.data)return!1;break;case"FLOAT":let e=t.data,a=r.data;if(Math.abs(e-a)>1e-12)return!1;break;case"RATIO":if(t.data.compare(r.data)==!1)return!1;break;case"ID":case"CHAR":case"STR":if(t.data!==r.data)return!1;break;default:throw new Error("unimplemented SExpr.equalp(..) type "+t.type)}return!0}static match(t,r,e){if(t.type==="ID"){let a=t.data;if(a.startsWith("$")){let s=a.substring(1);if(s in e){if(n.equalp(e[s],r)==!1)return!1}else e[s]=r;return!0}}if(t.type==="CONS"&&t.car.type==="ID"){let a=t.car.data;if(a.startsWith("$$")){let s=a.substring(2);return s in e&&n.equalp(e[s],r)==!1?!1:(e[s]=r,!0)}}return t.type!==r.type?!1:t.type==="CONS"?n.match(t.car,r.car,e)&&n.match(t.cdr,r.cdr,e):t.data===r.data}remove(t){let r,e;r=n.atomNIL();let a=this,s=0;for(;a.type!=="NIL";){let u=a.car;u.type!=="CONS"&&u.type===t.type&&u.data===t.data||(s==0?r=e=n.cons(u,n.atomNIL()):(e.cdr=n.cons(u,n.atomNIL()),e=e.cdr)),a=a.cdr,s++}return r}static subst(t,r,e){return r.type==="CONS"?e:r.type===e.type&&r.data===e.data?t:e.type==="CONS"?n.cons(n.subst(t,r,e.car),n.subst(t,r,e.cdr)):e}toFloat(){switch(this.type){case"INT":case"FLOAT":return this.data;case"RATIO":return this.data.toFloat();default:return 0}}toCode(){switch(this.type){case"T":return"SExpr.atomT()";case"NIL":return"SExpr.atomNIL()";case"INT":case"FLOAT":return"SExpr.atomINT("+this.data+")";case"RATIO":return"SExpr.atomRATIO("+this.data.numerator+","+this.data.denominator+")";case"CONS":return"SExpr.cons("+this.car.toCode()+","+this.cdr.toCode()+")";default:throw Error("unimplemented SExpr.toCode() for type "+this.type)}}toString(t=!1,r=0){switch(this.type){case"NIL":return"NIL";case"T":return"T";case"INT":return""+this.data;case"FLOAT":return""+this.data;case"RATIO":return""+this.data.toString();case"ID":case"GLOBAL":return this.data;case"CHAR":return"#\\"+this.data;case"STR":return'"'+this.data+'"';case"DEFUN":return"FUNCTION "+this.car.data;case"CONS":let e="";if(t){e+="
";for(let u=0;u<r*2;u++)e+=" ";r++}e+="(";let a=this,s=0;do{if(a.type==="NIL")break;if(s>0&&(e+=" "),a.type!="CONS"){e+=". "+a.toString(t,r);break}e+=a.car.toString(t,r),a=a.cdr,s++}while(a!=null);return e+=")",r--,e;default:throw new Error("unimplemented")}}};return b(p);})();
`;var g=class{constructor(){this.breakpointLine=0;this.col=0;this.variableValues={}}},L=class{constructor(){this.interpret=!0;this.output="";this.program=[];this.code="";this.genVarCtr=0;this.functions={};this.variables=[{}];this.constants=new Set;this.startTime=0;this.maxSeconds=1/0;this.breakpoints=new Set;this.debugInfo=[];this.check=!0}import(t){let a=new N(t),r=new E;this.program=r.parse(a)}getOutput(){return this.output}getDebugInfo(){return this.debugInfo}addBreakpoint(t){this.breakpoints.add(t)}compile(){this.interpret=!1,this.genVarCtr=0;let t="";for(let a of this.program){this.code="";let r=this.eval(a);t+=this.code+r.data}return console.log(t),t=b+"var SExprType=RUNTIME.SExprType;var SExpr=RUNTIME.SExpr;"+t,t}run(t=!0,a=1/0){this.interpret=!0,this.output="",this.debugInfo=[],t&&(this.functions={},this.variables=[{}],this.constants=new Set),this.startTime=Date.now(),this.maxSeconds=a;let r=[];for(let e of this.program)r.push(this.eval(e));return r}genVar(){return"__"+this.genVarCtr++}eval(t,a=!1){if(this.breakpoints.size>0&&this.breakpoints.has(t.srcRow)){let e=new g;this.debugInfo.length>0&&this.debugInfo[this.debugInfo.length-1].breakpointLine==t.srcRow&&this.debugInfo[this.debugInfo.length-1].col!=t.srcCol&&this.debugInfo.pop(),this.debugInfo.push(e),e.breakpointLine=t.srcRow,e.col=t.srcCol;let i=this.variables.length;for(let s=i-1;s>=0;s--)for(let o in this.variables[s]){let h=this.variables[s][o].toString();o in e.variableValues||(e.variableValues[o]=h)}}if(this.maxSeconds!=1/0&&(Date.now()-this.startTime)/1e3>this.maxSeconds)throw new c("max allowed runtime exceeded!");let r="";switch(t.type){case"NIL":return this.interpret?t:n.atomSTRING("SExpr.atomNIL()");case"T":return this.interpret?t:n.atomSTRING("SExpr.atomT()");case"INT":return this.interpret?t:n.atomSTRING("SExpr.atomINT("+t.data+")");case"RATIO":return this.interpret?t:n.atomSTRING("SExpr.atomRATIO("+t.data.numerator+","+t.data.denominator+")");case"FLOAT":return this.interpret?t:n.atomSTRING("SExpr.atomFLOAT("+t.data+")");case"CHAR":return this.interpret?t:n.atomSTRING("SExpr.atomCHAR("+t.data+")");case"STR":return this.interpret?t:n.atomSTRING("SExpr.atomSTR("+t.data+")");case"ID":{if(!this.interpret)throw new c("case T.ID NOT IMPLEMENTED");let e=t.data,i=this.variables.length;for(let s=i-1;s>=0;s--)if(e in this.variables[s])return this.variables[s][e];if(a)return this.variables[i-1][e]=n.atomNIL(),this.variables[i-1][e];throw new c("unknown symbol "+e)}case"CONS":switch(t.car.type){case"INT":case"RATIO":case"FLOAT":case"STR":throw new c(""+t.car.data+" is not a function name");case"CONS":{if(!this.interpret)throw new c("UNIMPLEMENTED");let e=this.eval(t.car);if(this.check&&e.type!=="DEFUN")throw new c("not a function");return this.call(e.cdr.car,t.cdr,e.cdr.cdr)}case"ID":switch(r=t.car.data,r){case"+":case"*":{if(!this.interpret)throw new c("UNIMPLEMENTED");let e=n.atomINT(r==="+"?0:1);for(let i=t.cdr,s=0;i.type==="CONS";i=i.cdr,s++){let o=this.eval(i.car);if(e.type==="INT"&&o.type==="INT")r==="+"?e.data+=o.data:e.data*=o.data;else if(e.type==="INT"&&o.type==="RATIO"){let h=l.fromNumber(e.data),u=o.data;e.data=r==="+"?l.add(h,u):l.mul(h,u),e.type="RATIO"}else if(e.type==="RATIO"&&o.type==="INT"){let h=e.data,u=l.fromNumber(o.data);e.data=r==="+"?l.add(h,u):l.mul(h,u),e.type="RATIO"}else if(e.type==="RATIO"&&o.type==="RATIO"){let h=e.data,u=o.data;e.data=r==="+"?l.add(h,u):l.mul(h,u),e.type="RATIO"}else if(["INT","RATIO","FLOAT"].includes(e.type)&&["INT","RATIO","FLOAT"].includes(o.type)){let h=e.type==="RATIO"?e.data.toFloat():e.data,u=o.type==="RATIO"?o.data.toFloat():o.data;e.data=r==="+"?h+u:h*u,e.type="FLOAT"}else throw new c("incompatible types "+e.type+" and "+o.type+" for op "+r)}return e.type==="RATIO"&&e.data.denominator==1&&(e.data=e.data.numerator,e.type="INT"),e}case"-":case"/":{if(!this.interpret)throw new c("UNIMPLEMENTED");let e=n.atomINT(r==="-"?0:1);for(let i=t.cdr,s=0;i.type==="CONS";i=i.cdr,s++){let o=this.eval(i.car);if(s==0&&i.cdr.type!=="NIL")e.type=o.type,e.data=o.data;else if(e.type==="INT"&&o.type==="INT")if(r==="-")e.data-=o.data;else{let h=e.data,u=o.data;e.data=new l(h,u),e.type="RATIO"}else if(e.type==="INT"&&o.type==="RATIO"){let h;h=l.fromNumber(e.data);let u=o.data;e.data=r==="-"?l.sub(h,u):l.div(h,u),e.type="RATIO"}else if(e.type==="RATIO"&&o.type==="INT"){let h=e.data,u=l.fromNumber(o.data);e.data=r==="-"?l.sub(h,u):l.div(h,u),e.type="RATIO"}else if(e.type==="RATIO"&&o.type==="RATIO"){let h=e.data,u=o.data;e.data=r==="-"?l.sub(h,u):l.div(h,u),e.type="RATIO"}else if(["INT","RATIO","FLOAT"].includes(e.type)&&["INT","RATIO","FLOAT"].includes(o.type)){let h=e.type==="RATIO"?e.data.toFloat():o.data,u=o.type==="RATIO"?o.data.toFloat():o.data;e.data=r==="-"?h-u:h/u,e.type="FLOAT"}else throw new c("incompatible types "+e.type+" and "+o.type+" for op "+r)}return e.type==="RATIO"&&e.data.denominator==1&&(e.data=e.data.numerator,e.type="INT"),e}case">":case">=":case"<":case"<=":{if(!this.interpret)throw new c("UNIMPLEMENTED");let e=!0,i=r===">"||r===">="?1/0:-1/0,s;for(let o=t.cdr,h=0;o.type=="CONS";o=o.cdr,h++){let u=this.eval(o.car);switch(u.type){case"INT":let d=u.data;if(r===">"&&d>=i||r===">="&&d>i||r==="<"&&d<=i||r==="<="&&d<i){e=!1;break}else i=d;break;default:throw new c(u.toString()+" is not a number")}}if(s==0)throw new c("too few args");return e?n.atomT():n.atomNIL()}case"AND":{if(!this.interpret)throw new c("UNIMPLEMENTED");let e=n.atomT();for(let i=t.cdr;i.type==="CONS";i=i.cdr){let s=this.eval(i.car);if(s.type==="NIL")return s;e=s}return e}case"APPEND":{if(!this.interpret)throw new c("UNIMPLEMENTED");let e=n.atomNIL(),i=e;for(let s=t.cdr;s.type!=="NIL";s=s.cdr){let o=this.eval(s.car);for(let h=o;h.type!=="NIL";h=h.cdr){let u=n.cons(h.car,n.atomNIL());e.type==="NIL"?e=i=u:(i.cdr=u,i=i.cdr)}}return e}case"APPLY":{if(!this.interpret)throw new c("UNIMPLEMENTED");this.check&&this.checkMinArgCount(t,2);let e=this.eval(t.cdr.car);if(this.check&&e.type!=="DEFUN")throw new c("expected a function");let i=this.eval(t.cdr.cdr.car);return this.call(e.cdr.car,i,e.cdr.cdr)}case"ATOM":{if(!this.interpret)throw new c("UNIMPLEMENTED");return this.check&&this.checkArgCount(t,1),this.eval(t.cdr.car).type!=="CONS"?n.atomT():n.atomNIL()}case"BACKQUOTE":{if(!this.interpret)throw new c("UNIMPLEMENTED");return this.check&&this.checkArgCount(t,1),this.backquote(t.cdr.car)}case"CAR":if(this.interpret){this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car);if(this.check&&e.type!=="CONS")throw new c(r+" expects a list");return e.car}else return n.atomSTRING(this.eval(t.cdr.car)+".car");case"CDR":if(this.interpret){this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car);if(this.check&&e.type!=="CONS")throw new c(r+" expects a list");return e.cdr}else return n.atomSTRING(this.eval(t.cdr.car)+".cdr");case"CHAR":{if(!this.interpret)throw new c("UNIMPLEMENTED");this.check&&this.checkArgCount(t,2);let e=this.eval(t.cdr.car),i=this.eval(t.cdr.cdr.car);if(this.check&&e.type!=="STR")throw new c("Expected a string");if(this.check&&i.type!=="INT")throw new c("Expected an integer index");let s=e.data,o=i.data;if(this.check&&(o<0||o>=s.length))throw new c("invalid string index");return n.atomCHAR(s[o])}case"COMMA":throw new c("COMMA NOT ALLOWED OUTSIDE OF BACKQUOTE");case"CONS":{if(!this.interpret)throw new c("UNIMPLEMENTED");return this.check&&this.checkArgCount(t,2),n.cons(this.eval(t.cdr.car),this.eval(t.cdr.cdr.car))}case"CONSP":{if(!this.interpret)throw new c("UNIMPLEMENTED");return this.check&&this.checkArgCount(t,1),this.eval(t.cdr.car).type==="CONS"?n.atomT():n.atomNIL()}case"COS":{if(!this.interpret)throw new c("UNIMPLEMENTED");this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car);return this.check&&this.checkIsNumber(e),n.atomFLOAT(Math.cos(e.toFloat()))}case"DEFCONSTANT":{if(!this.interpret)throw new c("UNIMPLEMENTED");this.check&&this.checkArgCount(t,2);let e=t.cdr.car,i=this.eval(t.cdr.cdr.car);if(this.check&&e.type!=="ID")throw new c("expected ID");let s=e.data;return this.variables[0][s]=i,this.constants.add(s),n.global(s)}case"DEFPARAMETER":{if(!this.interpret)throw new c("UNIMPLEMENTED");this.check&&this.checkArgCount(t,2);let e=t.cdr.car,i=this.eval(t.cdr.cdr.car);if(this.check&&e.type!=="ID")throw new c("expected ID");let s=e.data;return this.variables[0][s]=i,n.global(s)}case"DEFUN":{if(!this.interpret)throw new c("UNIMPLEMENTED");if(this.check&&(this.checkMinArgCount(t,2),n.nth(t,1).type!=="ID"||!(n.nth(t,2).type==="CONS"||n.nth(t,2).type==="NIL")))throw new c("DEFUN is not well structured");let e=n.nth(t,1).data,i=n.nthcdr(t,2);return this.functions[e]=i,n.defun(e,i)}case"DO":{if(!this.interpret)throw new c("UNIMPLEMENTED");let e=n.atomNIL(),i={};this.variables.push(i);let s=n.nth(t,1),o=n.nth(t,2),h=n.nthcdr(t,3);if(this.check&&(s.type!=="CONS"||o.type!=="CONS"))throw new c("DO is not well structured");for(let u=s;u.type!=="NIL";u=u.cdr){let d=n.nth(u.car,0);if(this.check&&d.type!=="ID")throw new c("expected ID");let f=this.eval(n.nth(u.car,1));i[d.data]=f}for(;;){let u=!1;for(let d=0,f=o;f.type!=="NIL";d++,f=f.cdr){let I=this.eval(f.car);if(d==0)if(I.type==="T")u=!0;else break;d>0&&(e=I)}if(u)break;for(let d=h;d.type!=="NIL";d=d.cdr)this.eval(d.car);for(let d=s;d.type!=="NIL";d=d.cdr){let f=n.nth(d.car,0),I=this.eval(n.nth(d.car,2));i[f.data]=I}}return this.variables.pop(),e}case"DOLIST":{if(!this.interpret)throw new c("UNIMPLEMENTED");let e=n.atomNIL(),i={};this.variables.push(i);let s=n.deepNth(t,[1,0]);if(this.check&&s.type!=="ID")throw new c("expected ID");let o=this.eval(n.deepNth(t,[1,1])),h=n.nthcdr(t,2);for(;o.type!=="NIL";){i[s.data]=o.car;for(let u=h;u.type!=="NIL";u=u.cdr)this.eval(u.car);o=o.cdr}return this.variables.pop(),e}case"EQUALP":{if(!this.interpret)throw new c("UNIMPLEMENTED");return this.check&&this.checkArgCount(t,2),n.equalp(this.eval(t.cdr.car),this.eval(t.cdr.cdr.car))?n.atomT():n.atomNIL()}case"FUNCALL":{if(!this.interpret)throw new c("UNIMPLEMENTED");this.check&&this.checkMinArgCount(t,2);let e=this.eval(t.cdr.car);if(this.check&&e.type!=="DEFUN")throw new c("expected a function");return this.call(e.cdr.car,t.cdr.cdr,e.cdr.cdr)}case"FUNCTION":{if(!this.interpret)throw new c("UNIMPLEMENTED");this.check&&this.checkArgCount(t,1);let e=t.cdr.car;if(this.check&&e.type!=="ID")throw new c("expected ID");let i=e.data;if(this.check&&!(i in this.functions))throw new c("undefined function "+i);return n.defun(i,this.functions[i])}case"IF":{if(!this.interpret)throw new c("UNIMPLEMENTED");return this.checkMinArgCount(t,2),this.eval(n.nth(t,1)).type!=="NIL"?this.eval(n.nth(t,2)):this.eval(n.nth(t,3))}case"LAMBDA":{if(!this.interpret)throw new c("UNIMPLEMENTED");return n.defun("LAMBDA",n.nthcdr(t,1))}case"LENGTH":if(this.interpret){this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car),i;for(i=0;e.type==="CONS";i++)e=e.cdr;return n.atomINT(i)}else{let e=this.genVar(),i=this.genVar(),s=this.eval(t.cdr.car),o=`let ${e}=${s};
let ${i};
for(${i}=0; ${e}.type === SExprType.CONS; ${i}++)
  ${e} = ${e}.cdr;
`;return this.code+=o,n.atomSTRING(`SExpr.atomINT(${i})`)}case"LET":{if(!this.interpret)throw new c("UNIMPLEMENTED");let e=n.atomNIL(),i={};this.variables.push(i);let s=n.nth(t,1),o=n.nthcdr(t,2);for(let h=s;h.type!=="NIL";h=h.cdr){if(this.check&&n.len(h.car)!=2)throw new c("expected (id init)");let u=n.nth(h.car,0);if(this.check&&u.type!=="ID")throw new c("expected ID");let d=this.eval(n.nth(h.car,1));i[u.data]=d}for(let h=o;h.type!=="NIL";h=h.cdr)e=this.eval(h.car);return this.variables.pop(),e}case"LIST":{if(!this.interpret)throw new c("UNIMPLEMENTED");let e,i;e=i=n.atomNIL();for(let s=t.cdr,o=0;s.type==="CONS";s=s.cdr,o++){let h=this.eval(s.car),u=n.cons(h,n.atomNIL());o==0?e=i=u:(i.cdr=u,i=i.cdr)}return e}case"LISTP":{if(!this.interpret)throw new c("UNIMPLEMENTED");this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car);return e.type==="CONS"||e.type==="NIL"?n.atomT():n.atomNIL()}case"MEMBER":{if(!this.interpret)throw new c("UNIMPLEMENTED");this.check&&this.checkArgCount(t,2);let e=this.eval(n.nth(t,1)),i=this.eval(n.nth(t,2)),s=n.atomNIL();for(let o=i;o.type!=="NIL";o=o.cdr)n.equalp(e,o.car)&&(s=o);return s}case"NOT":{if(!this.interpret)throw new c("UNIMPLEMENTED");return this.check&&this.checkArgCount(t,1),this.eval(t.cdr.car).type==="NIL"?n.atomT():n.atomNIL()}case"NTH":{if(!this.interpret)throw new c("UNIMPLEMENTED");this.check&&this.checkArgCount(t,2);let e=t.cdr.car,i=this.eval(t.cdr.cdr.car);if(this.check&&e.type!=="INT")throw new c("expected an integer index");let s=e.data;if(this.check&&s<0)throw new c("expected a non-negative integer index");return n.nth(i,s)}case"NTHCDR":{if(!this.interpret)throw new c("UNIMPLEMENTED");this.check&&this.checkArgCount(t,2);let e=t.cdr.car,i=this.eval(t.cdr.cdr.car);if(this.check&&e.type!=="INT")throw new c("expected an integer index");let s=e.data;if(this.check&&s<0)throw new c("expected a non-negative integer index");return n.nthcdr(i,s)}case"NULL":{if(!this.interpret)throw new c("UNIMPLEMENTED");return this.check&&this.checkArgCount(t,1),this.eval(t.cdr.car).type==="NIL"?n.atomT():n.atomNIL()}case"NUMBERP":{if(!this.interpret)throw new c("UNIMPLEMENTED");this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car);return e.type==="INT"||e.type==="FLOAT"||e.type==="RATIO"?n.atomT():n.atomNIL()}case"OR":{if(!this.interpret)throw new c("UNIMPLEMENTED");let e=n.atomNIL();for(let i=t.cdr;i.type==="CONS";i=i.cdr){let s=this.eval(i.car);if(s.type!=="NIL")return s;e=s}return e}case"PROGN":{if(!this.interpret)throw new c("UNIMPLEMENTED");let e=n.atomNIL();for(let i=t.cdr;i.type==="CONS";i=i.cdr)e=this.eval(i.car);return e}case"QUOTE":return this.interpret?(this.check&&this.checkArgCount(t,1),t.cdr.car):n.atomSTRING(t.cdr.car.toCode());case"REMOVE":{if(!this.interpret)throw new c("UNIMPLEMENTED");this.check&&this.checkArgCount(t,2);let e=t.cdr.car;return this.eval(t.cdr.cdr.car).remove(e)}case"REWRITE":{if(!this.interpret)throw new c("UNIMPLEMENTED");this.check&&this.checkMinArgCount(t,4);let i=this.eval(n.nth(t,1)),s=[],o=[],h=[],u=n.nthcdr(t,2);for(;u.type!=="NIL";)s.push(this.eval(u.car)),u=u.cdr,o.push(u.car),u=u.cdr,h.push(u.car),u=u.cdr;let d=s.length;return this.rewrite(d,s,o,h,i)}case"TAN":{if(!this.interpret)throw new c("UNIMPLEMENTED");this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car);return this.check&&this.checkIsNumber(e),n.atomFLOAT(Math.tan(e.toFloat()))}case"THIRD":{if(!this.interpret)throw new c("UNIMPLEMENTED");this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car);return n.nth(e,2)}case"TYPEP":{if(!this.interpret)throw new c("UNIMPLEMENTED");this.check&&this.checkArgCount(t,2);let e=this.eval(t.cdr.car),i=this.eval(t.cdr.cdr.car);if(this.check&&i.type!=="ID")throw new c("expected ID as second param");let s=i.data;if(this.check&&["INTEGER","FLOAT","RATIO"].includes(s)==!1)throw new c("unexpected TYPE "+s);if(e.type==="INT"&&s==="INTEGER"||e.type==="FLOAT"&&s==="FLOAT"||e.type==="RATIO"&&s==="RATIO")return n.atomT();n.atomNIL()}case"SETF":{if(!this.interpret)throw new c("UNIMPLEMENTED");let e=n.len(t);this.check&&this.checkEvenArgCount(t);let i=n.atomNIL();for(let s=t.cdr;s.type!=="NIL";s=s.cdr){let o=s.car;i=this.eval(o,!0),s=s.cdr;let h=this.eval(s.car);i.set(h)}return i}case"SIN":{if(!this.interpret)throw new c("UNIMPLEMENTED");this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car);return this.check&&this.checkIsNumber(e),n.atomFLOAT(Math.sin(e.toFloat()))}case"SUBSTITUTE":case"SUBST":{if(!this.interpret)throw new c("UNIMPLEMENTED");this.check&&this.checkArgCount(t,3);let e=this.eval(n.nth(t,1)),i=this.eval(n.nth(t,2)),s=this.eval(n.nth(t,3));return n.subst(e,i,s)}case"TERPRI":{if(!this.interpret)throw new c("UNIMPLEMENTED");return this.output+=`
`,n.atomNIL()}case"WRITE":if(this.interpret){this.check&&this.checkArgCount(t,1);let e=this.eval(t.cdr.car);return this.output+=e.toString(),console.log(e.toString()),e}else{let e=this.genVar(),i=`let ${e} = ${this.eval(t.cdr.car)};`;return this.code+=i,this.code+=`console.log(${e}.toString());`,n.atomSTRING(e)}default:{if(!this.interpret)throw new c("UNIMPLEMENTED");let e=this.functions[r];if(this.check&&e==null)throw new c("unknown function "+r);return this.call(e.car,t.cdr,e.cdr)}}default:throw new c("not allowed")}default:throw new c("unimplemented sexpr type "+t.type)}}rewrite(t,a,r,e,i){let s,o=0;do{s=!1,i.type==="CONS"&&(i.car=this.rewrite(t,a,r,e,i.car),i.cdr=this.rewrite(t,a,r,e,i.cdr));for(let h=0;h<t;h++){let u={};if(this.variables.push(u),n.match(a[h],i,u)&&this.eval(r[h]).type!=="NIL"){let f=i.toString();i=this.eval(e[h]),i=this.resolveTilde(i),console.log("REWROTE "+f+" -> "+i.toString()+" (USING RULE "+a[h].toString()+" -> "+e[h].toString()+")"),s=!0,o++}this.variables.pop()}}while(s);return i}resolveTilde(t){if(t.type==="CONS"&&(t.car=this.resolveTilde(t.car),t.cdr=this.resolveTilde(t.cdr),t.car.type==="ID"&&t.cdr.type!=="NIL"&&t.car.data==="~")){let a=t.cdr.cdr;t=t.cdr.car;let r=t;for(;r.cdr.type!=="NIL";)r=r.cdr;r.cdr=a}return t}backquote(t){if(t.type==="CONS"){if(t.car.type==="ID"&&t.car.data==="COMMA")return this.eval(t.cdr.car);t.car=this.backquote(t.car),t.cdr=this.backquote(t.cdr)}return t}call(t,a,r){let e={};this.variables.push(e);let i,s;for(i=a,s=t;s.type!=="NIL";i=i.cdr,s=s.cdr){if(this.check&&i.type==="NIL")throw new c("too few arguments");let h=s.car;if(this.check&&h.type!=="ID")throw new c("parameter must be an ID");e[h.data]=this.eval(i.car)}if(this.check&&i.type!=="NIL")throw new c("too many arguments");let o=n.atomNIL();for(;r.type!=="NIL";r=r.cdr)o=this.eval(r.car);return this.variables.pop(),o}checkArgCount(t,a){if(n.len(t)!=a+1)throw new c("expected "+a+" argument"+(a>0?"s":"#"))}checkMinArgCount(t,a){if(n.len(t)<a+1)throw new c("expected "+a+"+ argument"+(a>0?"s":"#"))}checkEvenArgCount(t){if((n.len(t)-1)%2!=0)throw new c("expected an even number of arguments")}checkIsNumber(t){if(t.type!=="INT"&&t.type!=="FLOAT"&&t.type!=="RATIO")throw new c("expected a number")}},y=class extends Error{constructor(t){super("Error: "+t),this.name="CompileError"}},c=class extends Error{constructor(t){super("Error: "+t),this.name="RunError"}};return v(D);})();
